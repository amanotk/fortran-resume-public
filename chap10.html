

<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10. 付録 &mdash; Fortran演習(地球惑星物理学演習)</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5349f25f" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=9f0ccda0" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=528de7ef"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=4755f45a"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="prev" title="9. モジュールと構造型" href="chap09.html" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.18.1/build/cssreset/cssreset-min.css">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99010794-2', 'auto');
  ga('send', 'pageview');

</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Fortran演習
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chap01.html">1. はじめに</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">2. プログラムの作成と実行</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">3. 変数・データ型・基本的な計算</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">4. 制御構造</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">5. 配列</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">6. 書式指定・ファイル入出力・文字列処理</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">7. 関数とサブルーチン</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">8. 数値解析の基礎</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">9. モジュールと構造型</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. 付録</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id3">10.1. 大規模なプログラム開発</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">10.1.1. 分割コンパイル</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">10.1.2. ライブラリの利用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gui">10.1.3. GUIプログラムの作成 <sup>†</sup></a></li>
<li class="toctree-l3"><a class="reference internal" href="#make">10.1.4. Makeの使い方</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">10.2. 関数やサブルーチンの引数渡し</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">10.3. 計算時間の測定</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id11">10.4. ポインタとデータ構造 <sup>†</sup></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">10.4.1. ポインタ変数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">10.4.2. ポインタ配列</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-data-structure">10.4.3. データ構造</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id17">10.5. デバッグのテクニック <sup>†</sup></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id18">10.5.1. プリプロセッサ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#printf">10.5.2. printfデバッグ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gdb">10.5.3. gdb</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#c">10.6. C言語とのリンク <sup>†</sup></a></li>
<li class="toctree-l2"><a class="reference internal" href="#fortran-77">10.7. Fortran 77について <sup>†</sup></a></li>
<li class="toctree-l2"><a class="reference internal" href="#id22">10.8. 第10章 演習課題</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id23">10.8.1. 課題1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">10.8.2. 課題2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25">10.8.3. 課題3 <sup>†</sup></a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Fortran演習</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">10. </span>付録</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">10. </span>付録</a><a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<ul class="simple">
<li><p><a class="reference internal" href="chap10_sample1_f90.html"><span class="doc">sample1.f90</span></a> : 分割コンパイル用サンプル</p></li>
<li><p><a class="reference internal" href="chap10_sample1a_f90.html"><span class="doc">sample1a.f90</span></a> : 分割コンパイル用サンプル(モジュールA)</p></li>
<li><p><a class="reference internal" href="chap10_sample1b_f90.html"><span class="doc">sample1b.f90</span></a> : 分割コンパイル用サンプル(モジュールB)</p></li>
<li><p><a class="reference internal" href="chap10_sample2_f90.html"><span class="doc">sample2.f90</span></a> : GUIライブラリの使い方</p></li>
<li><p><a class="reference internal" href="chap10_sample3_f90.html"><span class="doc">sample3.f90</span></a> : 二分法モジュール(mod_bisection)の使い方</p></li>
<li><p><a class="reference internal" href="chap10_bisection_f90.html"><span class="doc">bisection.f90</span></a> : 二分法モジュール(mod_bisection)の実装</p></li>
<li><p><a class="reference internal" href="chap10_sample4_f90.html"><span class="doc">sample4.f90</span></a> : 計算時間の測定</p></li>
<li><p><a class="reference internal" href="chap10_sample5_f90.html"><span class="doc">sample5.f90</span></a> : ポインタの使い方</p></li>
<li><p><a class="reference internal" href="chap10_sample6_f90.html"><span class="doc">sample6.f90</span></a> : リストモジュール(mod_list)の使い方</p></li>
<li><p><a class="reference internal" href="chap10_list_f90.html"><span class="doc">list.f90</span></a> : リストモジュール(mod_list)の実装</p></li>
<li><p><a class="reference internal" href="chap10_sample7_f90.html"><span class="doc">sample7.f90</span></a> : プリプロセッサの使い方</p></li>
</ul>
</div>
<nav class="contents" id="id2">
<p class="topic-title">この章の内容</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id35">付録</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id36">大規模なプログラム開発</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id37">関数やサブルーチンの引数渡し</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id38">計算時間の測定</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id39">ポインタとデータ構造 <sup>†</sup></a></p></li>
<li><p><a class="reference internal" href="#id17" id="id40">デバッグのテクニック <sup>†</sup></a></p></li>
<li><p><a class="reference internal" href="#c" id="id41">C言語とのリンク <sup>†</sup></a></p></li>
<li><p><a class="reference internal" href="#fortran-77" id="id42">Fortran 77について <sup>†</sup></a></p></li>
<li><p><a class="reference internal" href="#id22" id="id43">第10章 演習課題</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="id3">
<h2><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">10.1. </span>大規模なプログラム開発</a><a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<section id="id4">
<h3><span class="section-number">10.1.1. </span>分割コンパイル<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<p>これまでは基本的に単一のソースファイルからなるプログラムを扱ってきたが，大規模なプログラムを扱う際にはソースファイルをいくつかに分割して扱うと開発の見通しが良くなる．複数のソースファイルからなるプログラムを開発するにあたって，まずは単一のソースファイルから実行形式のファイルを作る手順を復習しよう．</p>
<p>これまでは例えば</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>sample.f90
</pre></div>
</div>
<p>によってソースファイルから実行ファイル <code class="docutils literal notranslate"><span class="pre">a.out</span></code> を作成してきた．これは実際には <strong>コンパイル</strong> と <strong>リンク</strong> という2つのステップを同時に行うものである．</p>
<p>コンパイルとはソースファイルを解釈し，機械語に変換する作業である．機械語に変換されたファイルを <strong>オブジェクトファイル</strong> と呼び，通常は拡張子 <code class="docutils literal notranslate"><span class="pre">.o</span></code> が用いられる．オブジェクトファイルを生成するには</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>sample.f90
</pre></div>
</div>
<p>のように <code class="docutils literal notranslate"><span class="pre">-c</span></code> オプションを付けてコンパイルする．この結果，この例では <code class="docutils literal notranslate"><span class="pre">sample.o</span></code> が生成される．生成されたオブジェクトファイルは機械語になってはいても，実際にプログラムを実行可能な形式にはなっておらず，関数やサブルーチンなどの単位で個別に機械語になっているだけである．実行形式に変換するには，それらの自分で実装したものに加え，組み込み関数( <code class="docutils literal notranslate"><span class="pre">read</span></code> ，<code class="docutils literal notranslate"><span class="pre">write</span></code> なども実際には組み込み関数の1種である)などを連結する作業が必要である．組み込み関数などのまとまりを標準ライブラリと呼び，この連結作業をリンクと呼ぶ．</p>
<p>オブジェクトファイルをリンクするには</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>sample.o
</pre></div>
</div>
<p>とすればよい．この例では <code class="docutils literal notranslate"><span class="pre">sample.o</span></code> と標準ライブラリがリンクされ，実行可能なファイル(この例では <code class="docutils literal notranslate"><span class="pre">a.out</span></code> )が生成される．</p>
<p>次に複数のファイルからなるプログラムの場合を考えよう．例えばメインプログラムが定義されている <code class="docutils literal notranslate"><span class="pre">sample1.f90</span></code> が <code class="docutils literal notranslate"><span class="pre">sample1a.f90</span></code> に，また <code class="docutils literal notranslate"><span class="pre">sample1a.f90</span></code> が <code class="docutils literal notranslate"><span class="pre">sample1b.f90</span></code> に依存している場合には</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>sample1b.f90<span class="w"> </span>sample1a.f90<span class="w"> </span>sample1.f90
</pre></div>
</div>
<p>のようにすれば，コンパイルとリンクを1つのコマンドで同時に実行することができる(順番に注意)．これは実際には以下のように各ファイルを個別にコンパイルし，最後に全体をリンクする作業に相当する．</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>sample1b.f90
<span class="linenos">2</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>sample1a.f90
<span class="linenos">3</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>sample1.f90
<span class="linenos">4</span>$<span class="w"> </span>gfortran<span class="w"> </span>sample1b.o<span class="w"> </span>sample1a.o<span class="w"> </span>sample1.o
</pre></div>
</div>
<p>リンク時には与えられた全てのオブジェクトファイルに加えて，常に標準ライブラリがリンクされる．</p>
<p>このように分割コンパイルを用いる利点は，コンパイル時間の短縮にある．個別にコンパイルが出来るので，ソースファイルを更新した場合には，その必要なファイルだけを再コンパイルすれば良い．なお，リンクにかかる時間は通常短く，コンパイル時間に対しては無視できる．従って，頻繁に修正をしながらテストする場合などでは，実行ファイルの作成にかかる時間を短縮できることになる．</p>
<p>なお，Fortranでモジュールを用いる場合は <code class="docutils literal notranslate"><span class="pre">gfortran</span> <span class="pre">-c</span></code> によるコンパイルで <code class="docutils literal notranslate"><span class="pre">.mod</span></code> という拡張子のファイル(例えばモジュール名が <code class="docutils literal notranslate"><span class="pre">test</span></code> なら <code class="docutils literal notranslate"><span class="pre">test.mod</span></code> )が生成される．別ファイルのモジュールを利用する際には，この <code class="docutils literal notranslate"><span class="pre">.mod</span></code> ファイルが無いとコンパイル出来ないので注意しよう <a class="footnote-reference brackets" href="#id26" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>．また他のディレクトリに <code class="docutils literal notranslate"><span class="pre">.mod</span></code> ファイルがある場合には，<code class="docutils literal notranslate"><span class="pre">-I</span></code> オプションを用いてコンパイラが <code class="docutils literal notranslate"><span class="pre">.mod</span></code> ファイルを探す場所を指定することが出来る <a class="footnote-reference brackets" href="#id27" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>．</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>-I../module<span class="w"> </span>sample.f90
</pre></div>
</div>
<p>のように実行すれば，カレントディレクトリに加えて <code class="docutils literal notranslate"><span class="pre">../module</span></code> にある <code class="docutils literal notranslate"><span class="pre">.mod</span></code> ファイルも参照することになる．規模が大きなプログラムではいくつかのディレクトリにファイルを分散して配置するようになるため，<code class="docutils literal notranslate"><span class="pre">-I</span></code> オプションを頻繁に用いることになるだろう．</p>
</section>
<section id="id7">
<h3><span class="section-number">10.1.2. </span>ライブラリの利用方法<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>一般に，関数やサブルーチン群をひとまとまりにしたものをライブラリと呼ぶ．これまでにも組み込み関数などの標準で用意されている便利な機能を利用してきたが，これは標準ライブラリが提供するものである．これと同じように，他の誰かが開発した便利な関数やサブルーチンを自分のプログラムから呼び出して利用することも出来る．</p>
<p>ライブラリは通常(Unix系のOSでは) <code class="docutils literal notranslate"><span class="pre">libABC.a</span></code> や <code class="docutils literal notranslate"><span class="pre">libXYZ.so</span></code> といったファイル名になっている(これらをアーカイブとも呼ぶ)．基本的には実行形式のファイルを作成するリンク時にこれらのライブラリともリンクするように指定してやれば良い．例えば</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>main.o<span class="w"> </span>-lABC<span class="w"> </span>-lXYZ
</pre></div>
</div>
<p>とすれば <code class="docutils literal notranslate"><span class="pre">libABC.a</span></code>，<code class="docutils literal notranslate"><span class="pre">libXYZ.so</span></code> の両方とリンクすることが出来る．このようにライブラリとリンクするには，拡張子とファイル先頭の <code class="docutils literal notranslate"><span class="pre">lib</span></code> を除いたライブラリ名を <code class="docutils literal notranslate"><span class="pre">-l</span></code> オプションに渡せば良い．ただし，ライブラリファイルがあるディレクトリがカレントディレクトリや標準の場所(通常 <code class="docutils literal notranslate"><span class="pre">/usr/lib</span></code> や <code class="docutils literal notranslate"><span class="pre">/usr/local/lib</span></code> など)以外の場合にはその場所を <code class="docutils literal notranslate"><span class="pre">-L</span></code> オプションで明示的に指定してやらなければならない．以下の例では <code class="docutils literal notranslate"><span class="pre">libABC.a</span></code> が <code class="docutils literal notranslate"><span class="pre">../lib</span></code> にある場合に，それを明示的に指定してリンクを実行する．</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>main.o<span class="w"> </span>-L../lib<span class="w"> </span>-lABC
</pre></div>
</div>
</section>
<section id="gui">
<h3><span class="section-number">10.1.3. </span>GUIプログラムの作成 <sup>†</sup><a class="headerlink" href="#gui" title="Link to this heading"></a></h3>
<!--
数値計算関係のライブラリはこれからも多々使う機会があると思うので，ここではちょっと違った例としてGUI(Graphical User Interface)のライブラリを使ってみよう．GUIのライブラリは様々なものが存在するが，ここではFortranから使えるGTK+を用いる．サンプルプログラム`samle2.f90`をコンパイルするには

```{style=shell}
 $ gfortran sample2.f90 `pkg-config --cflags --libs gtk-2-fortran`
```

のようにすれば良い．
--></section>
<section id="make">
<h3><span class="section-number">10.1.4. </span>Makeの使い方<a class="headerlink" href="#make" title="Link to this heading"></a></h3>
<p>To be written.</p>
</section>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">10.2. </span>関数やサブルーチンの引数渡し</a><a class="headerlink" href="#id8" title="Link to this heading"></a></h2>
<p>関数やサブルーチンの引数として，関数やサブルーチンを渡すことが出来る．これには以下のように引数として渡す関数やサブルーチンの形式を <code class="docutils literal notranslate"><span class="pre">interface</span></code> を用いて指定する．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">subroutine </span><span class="n">writefunc</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 3</span><span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="c">! 引数として受け取る関数の形式</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="k">interface</span>
<span class="linenos"> 7</span><span class="k">     function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="w">       </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span>
<span class="linenos"> 9</span><span class="w">       </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">y</span>
<span class="linenos">10</span><span class="w">     </span><span class="k">end function </span><span class="n">f</span>
<span class="linenos">11</span><span class="w">  </span><span class="k">end interface</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">  write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(&quot;f(&quot;, e12.5, &quot;) = &quot;,  e12.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="k">end subroutine </span><span class="n">writefunc</span>
</pre></div>
</div>
<p>より実用的な例として二分法のアルゴリズムを実装した以下の様なモジュール(抜粋)を考えよう．<code class="docutils literal notranslate"><span class="pre">bisection</span></code> というサブルーチンは関数 <span class="math notranslate nohighlight">\(f(x)\)</span> を引数として受け取り，<span class="math notranslate nohighlight">\(f(x) = 0\)</span> の解を求める．このようなモジュールを定義しておけば，<span class="math notranslate nohighlight">\(f(x)\)</span> の具体的な形が変わってもメインプログラムで <code class="docutils literal notranslate"><span class="pre">bisection</span></code> の引数として渡す関数を変更するだけで良い．このように，汎用性の高いモジュールを作成しておくことで再利用が非常に簡単になる．</p>
<p>なお，このサブルーチンでは最大の反復回数や許容誤差は <code class="docutils literal notranslate"><span class="pre">optional</span></code> 属性の引数となっていることにも着目して欲しい．これらが与えられない場合にはモジュール内で定義されたデフォルトの値を用いるようになっている．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">mod_bisection</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 3</span><span class="k">  private</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">default_maxit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">default_tol</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-8_8</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bisection</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">contains</span>
<span class="linenos">11</span><span class="w">  </span><span class="c">! 二分法により与えられた方程式の解を求める</span>
<span class="linenos">12</span><span class="w">  </span><span class="k">subroutine </span><span class="n">bisection</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">maxit</span><span class="p">,</span><span class="w"> </span><span class="n">tol</span><span class="p">)</span>
<span class="linenos">13</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">14</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span>
<span class="linenos">15</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">status</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">maxit</span>
<span class="linenos">18</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tol</span>
<span class="linenos">19</span><span class="w">    </span><span class="c">! 引数として関数を受け取る</span>
<span class="linenos">20</span><span class="w">    </span><span class="k">interface</span>
<span class="linenos">21</span><span class="k">       function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">22</span><span class="w">         </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span>
<span class="linenos">23</span><span class="w">         </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">y</span>
<span class="linenos">24</span><span class="w">       </span><span class="k">end function </span><span class="n">f</span>
<span class="linenos">25</span><span class="w">    </span><span class="k">end interface</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">tolerance</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="w">    </span><span class="c">! 最大の反復回数</span>
<span class="linenos">31</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">maxit</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">32</span><span class="k">       </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">default_maxit</span>
<span class="linenos">33</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">34</span><span class="k">       </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxit</span>
<span class="linenos">35</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="c">! 許容誤差</span>
<span class="linenos">38</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">tol</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">39</span><span class="k">       </span><span class="n">tolerance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">default_tol</span>
<span class="linenos">40</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">41</span><span class="k">       </span><span class="n">tolerance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tol</span>
<span class="linenos">42</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">45</span><span class="w">    </span><span class="c">! 以下略</span>
<span class="linenos">46</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">bisection</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="k">end module </span><span class="n">mod_bisection</span>
</pre></div>
</div>
<p>なお <code class="docutils literal notranslate"><span class="pre">bisection.f90</span></code> で上記モジュールが定義されており，<code class="docutils literal notranslate"><span class="pre">sample3.f90</span></code> がこれを用いるメインプログラムである．これをコンパイルするには</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>bisection.f90
<span class="linenos">2</span>$<span class="w"> </span>gfortran<span class="w"> </span>-c<span class="w"> </span>sample3.f90
<span class="linenos">3</span>$<span class="w"> </span>gfortran<span class="w"> </span>sample3.o<span class="w"> </span>bisection.o
</pre></div>
</div>
<p>もしくは</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>bisection.f90<span class="w"> </span>sample3.f90
</pre></div>
</div>
<p>とすれば良い．</p>
</section>
<section id="id9">
<h2><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">10.3. </span>計算時間の測定</a><a class="headerlink" href="#id9" title="Link to this heading"></a></h2>
<p>プログラム全体の実行時間はシェルコマンドで計測できる．例えば <code class="docutils literal notranslate"><span class="pre">time</span></code> コマンドを用いて以下のように実行すれば良い <a class="footnote-reference brackets" href="#id28" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>．realの行が実際の実行時間を示している．大雑把には全実行時間のうち，userが自分のプログラムの処理が動いていた時間，sysはOSの処理が動いていた時間を表す．</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>/usr/bin/time<span class="w"> </span>./a.out
<span class="linenos">2</span><span class="w">       </span><span class="m">0</span>.98<span class="w"> </span>real<span class="w">         </span><span class="m">0</span>.97<span class="w"> </span>user<span class="w">         </span><span class="m">0</span>.00<span class="w"> </span>sys
</pre></div>
</div>
<p>アルゴリズムによる実効速度の違いを検証したり，プログラムのチューニングをするようになってくると，プログラムのある特定の部分の実行時間を測定する必要が出てくる．ここでは <code class="docutils literal notranslate"><span class="pre">cpu_time</span></code> という組込みサブルーチンを使った時間計測のサンプルプログラムを以下に示す．</p>
<p>実行結果は以下のようになる．</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>./a.out
<span class="linenos">2</span>CPU<span class="w"> </span>Time<span class="w"> </span><span class="o">[</span>sec<span class="o">]</span><span class="w"> </span>:<span class="w">   </span><span class="m">0</span>.8601E+00
</pre></div>
</div>
<p>サンプルプログラムでは9-12行目の処理にかかる時間を計測している．<code class="docutils literal notranslate"><span class="pre">cpu_time</span></code> の呼び出しによって引数に現在の時刻が秒単位で代入されるので，計測したい部分の前後でこの値の差をとればよい．ただし正確に計算時間を計測する際には以下のようにいくつか注意が必要である．</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">write</span></code> や <code class="docutils literal notranslate"><span class="pre">read</span></code> のようなI/O(入出力)は避ける.これらは非常に時間のかかる処理であるので，入出力があると純粋な計算時間を正確に測ることが出来ない．</p></li>
<li><p>計測対象がある程度時間のかかる処理(例えば <span class="math notranslate nohighlight">\(\gtrsim 1\)</span> 秒)であること．<code class="docutils literal notranslate"><span class="pre">cpu_time</span></code> の返す時刻の精度は <span class="math notranslate nohighlight">\(1 \mu s\)</span> 程度である．</p></li>
<li><p>何度か同じ計測をしてばらつきを見ること．現在のほぼ全ての計算機はマルチタスクOSであり，多くの処理を同時に行なっているため，ユーザーが実行しているプログラムの処理に全てのリソースが使われるわけではない．たまたま他のプログラムが走っているタイミングで実行された場合にはパフォーマンスがでない可能性がある．</p></li>
</ul>
<p>なお，細かいことを言うと経過時間(elapsed time)，CPU時間(cpu time)，システムCPU時間(system cpu time)，ユーザーCPU時間(user cpu time)で意味が少しずつ異なることに注意しよう．<code class="docutils literal notranslate"><span class="pre">cpu_time</span></code> で計測されるのはCPU時間である．</p>
</section>
<section id="id11">
<h2><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">10.4. </span>ポインタとデータ構造 <sup>†</sup></a><a class="headerlink" href="#id11" title="Link to this heading"></a></h2>
<p>ポインタとは簡単に言えば別名である．即ち，ポインタ変数は他の変数や配列によって保持されているデータ領域のメモリ上のアドレス(番地)を指し示す変数になっている．例えば，ポインタ変数に対する処理として記述しておけば，ポインタ変数の指し示すアドレスを変更するだけで異なるデータに対する処理を行っていることになる．</p>
<p>しかし，ポインタはこれまで出てきたような処理には敢えて用いる必要が無いので，あまりありがたみを感じられないかもしれない．実際にはポインタはリストやスタック，キューなどのより複雑な <a class="reference internal" href="#appendix-data-structure"><span class="std std-ref">データ構造</span></a> を記述するには必須であるが，そうでなければ必ずしも必要にはならない．ポインタは初心者には少し難しいかもしれないので，分からなければとりあえずは無視しても良い．</p>
<section id="id12">
<h3><span class="section-number">10.4.1. </span>ポインタ変数<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>ポインタを用いるには変数宣言に <code class="docutils literal notranslate"><span class="pre">pointer</span></code> 属性を指定すれば良い．またポインタが指し指すことの出来る変数(ターゲット変数)には <code class="docutils literal notranslate"><span class="pre">target</span></code> 属性を指定する必要がある．以下の例を考えよう．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iptr</span>
<span class="linenos"> 2</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">target</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="linenos"> 5</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="c">! 出力は iptr = 5, i = 5, j = 9</span>
<span class="linenos"> 8</span><span class="n">iptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">i</span>
<span class="linenos"> 9</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(&quot; iptr = &quot;, i3, &quot;, i = &quot;, i3, &quot;, j = &quot;, i3)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">iptr</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="c">! 出力は iptr = 9, i = 5, j = 9</span>
<span class="linenos">12</span><span class="n">iptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">j</span>
<span class="linenos">13</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(&quot; iptr = &quot;, i3, &quot;, i = &quot;, i3, &quot;, j = &quot;, i3)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">iptr</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c">! 出力は iptr = 0, i = 5, j = 0</span>
<span class="linenos">16</span><span class="n">iptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">17</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(&quot; iptr = &quot;, i3, &quot;, i = &quot;, i3, &quot; j, = &quot;, i3)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">iptr</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>
</pre></div>
</div>
<p>8行目の <code class="docutils literal notranslate"><span class="pre">iptr</span> <span class="pre">=&gt;</span> <span class="pre">i</span></code> によって <code class="docutils literal notranslate"><span class="pre">iptr</span></code> は <code class="docutils literal notranslate"><span class="pre">i</span></code> のアドレスを指すことになる( <code class="docutils literal notranslate"><span class="pre">iptr</span></code> が <code class="docutils literal notranslate"><span class="pre">i</span></code> の別名となる)ので，9行目の出力では&quot;iptr = 5, i = 5, j = 9&quot;となる．同様に12行目の <code class="docutils literal notranslate"><span class="pre">iptr</span> <span class="pre">=&gt;</span> <span class="pre">j</span></code> によって <code class="docutils literal notranslate"><span class="pre">iptr</span></code> は <code class="docutils literal notranslate"><span class="pre">j</span></code> のアドレスを指すことになる．また，16行目の <code class="docutils literal notranslate"><span class="pre">iptr</span> <span class="pre">=</span> <span class="pre">0</span></code> は <code class="docutils literal notranslate"><span class="pre">iptr</span></code> の指すアドレスへの代入なので，この結果 <code class="docutils literal notranslate"><span class="pre">iptr</span></code> だけでなく <code class="docutils literal notranslate"><span class="pre">j</span></code> の値も変更されることになる．この代入文のように，ポインタ変数に対しても通常の変数のように任意の演算が可能である <a class="footnote-reference brackets" href="#id29" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>．</p>
<p>なお <code class="docutils literal notranslate"><span class="pre">nullify</span></code> によってポインタ変数とターゲット変数との結合を解除することが出来る．またポインタは <strong>無名領域</strong> (他の変数によって指し示されていない領域)との結合も可能である．これは動的配列の場合と同様に <code class="docutils literal notranslate"><span class="pre">allocate</span></code> によって行い，この場合の結合の解除は( <code class="docutils literal notranslate"><span class="pre">nullify</span></code> では無く) <code class="docutils literal notranslate"><span class="pre">deallocate</span></code> によって行う．また，結合状態を検査するための組込み関数 <code class="docutils literal notranslate"><span class="pre">associated</span></code> も用意されている．この関数はポインタが結合状態であれば真，そうでなければ偽を返す．従って例えば以下のように使うことが出来る．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">iptr</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2</span><span class="k">  nullify</span><span class="p">(</span><span class="n">iptr</span><span class="p">)</span>
<span class="linenos">3</span><span class="k">end if</span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="k">allocate</span><span class="p">(</span><span class="n">iptr</span><span class="p">)</span>
<span class="linenos">6</span><span class="n">iptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos">7</span>
<span class="linenos">8</span><span class="k">deallocate</span><span class="p">(</span><span class="n">iptr</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3><span class="section-number">10.4.2. </span>ポインタ配列<a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<p>ポインタ配列はターゲット配列と結合させることが出来る．ただし両者の次元は同じでなければならない．ポインタ配列は配列全体を指したり，部分配列を指したりすることが出来る．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span>
<span class="linenos"> 2</span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lb</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">ub</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 3</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rptr</span><span class="p">(:,:)</span>
<span class="linenos"> 4</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">target</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span>
<span class="linenos"> 7</span><span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">9</span>
<span class="linenos"> 9</span><span class="w">   </span><span class="k">end do</span>
<span class="linenos">10</span><span class="k">end do</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="c">! 部分配列へ結合</span>
<span class="linenos">13</span><span class="n">rptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">lbound</span><span class="p">(</span><span class="n">rptr</span><span class="p">)</span><span class="w"> </span><span class="c">! (/1, 1/)</span>
<span class="linenos">16</span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">ubound</span><span class="p">(</span><span class="n">rptr</span><span class="p">)</span><span class="w"> </span><span class="c">! (/3, 5/)</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lb</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">ub</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">19</span><span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lb</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">ub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">20</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(i7)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">rptr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">21</span><span class="w">   </span><span class="k">end do</span>
<span class="linenos">22</span><span class="k">   write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span>
<span class="linenos">23</span><span class="k">end do</span>
</pre></div>
</div>
<p>上の例では13行目において <code class="docutils literal notranslate"><span class="pre">rptr</span></code> を <code class="docutils literal notranslate"><span class="pre">x</span></code> の部分配列と結合させている．ポインタ変数の場合と同様に，<code class="docutils literal notranslate"><span class="pre">rptr</span></code> は <code class="docutils literal notranslate"><span class="pre">x</span></code> への別名となり，このポインタ配列に対するアクセスは <code class="docutils literal notranslate"><span class="pre">x</span></code> の対応する要素へのアクセスと等しくなる．</p>
<p>またポインタ配列に対しても <code class="docutils literal notranslate"><span class="pre">allocate</span></code> による無名領域への結合が出来るので，動的配列と同様に用いることも可能である <a class="footnote-reference brackets" href="#id30" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>．</p>
</section>
<section id="appendix-data-structure">
<span id="id16"></span><h3><span class="section-number">10.4.3. </span>データ構造<a class="headerlink" href="#appendix-data-structure" title="Link to this heading"></a></h3>
<p>これまでの例では，ポインタは複雑な割にはありがたみが少ない．実際にポインタを使う必要性は特に感じられないだろう．ポインタが特に重要となってくるのは柔軟なデータ構造を扱う場合である．実は配列もデータ構造の一つである．配列はサイズが固定で，全ての要素が同じ型のデータの集まりなので比較的簡単に扱うことが出来る．すなわち，配列の各要素はメモリ上に連続的に配置されているので，任意の要素への直接アクセス(ランダムアクセス)が可能という長所を持つ(任意の要素のアドレスが簡単に計算出来る)．
その一方で，要素をある特定の位置に挿入したい場合にはそれ以降の要素を全てずらさなければならないし，サイズの変更が簡単には出来ないという短所がある．</p>
<figure class="align-center" id="id34">
<a class="reference internal image-reference" href="_images/list.png"><img alt="List構造．" src="_images/list.png" style="width: 480px;" />
</a>
<figcaption>
<p><span class="caption-text">List構造．</span><a class="headerlink" href="#id34" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>配列とよく対比されるデータ構造として，リスト(list)が知られている．図に示すようにリスト構造は各要素が他の要素へのポインタ(アドレス)を保持する．従って，リスト構造では任意の要素(例えば先頭から <span class="math notranslate nohighlight">\(N\)</span> 番目の要素)へのアクセスをしようと思ってもそのアドレスが分からない．すなわち，常に各要素に対して順番にアクセス(シーケンシャルアクセス)をしなければならない．これは配列に対するリスト構造の短所である．その一方で，任意の場所への要素の挿入や削除をするにはポインタアドレスの付け替えをするだけで実現出来る．また，リストの末尾に要素を追加するには新しい要素を生成( <code class="docutils literal notranslate"><span class="pre">allocate</span></code>)して，その要素に対するポインタを指定してやれば良い．このような特徴があるため，シーケンシャルアクセスしか必要とされない代わりに，頻繁にサイズ変更，要素の挿入・削除があるような用途にはリストが有用となる．</p>
<p>例として，各要素の値が整数であるリストは以下のように構造型を用いて定義することになる．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">list_type</span>
<span class="linenos">2</span><span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">list_type</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">next</span>
<span class="linenos">3</span><span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="k">value</span>
<span class="linenos">4</span><span class="k">end type </span><span class="n">list_type</span>
</pre></div>
</div>
<p>リストの実装( <code class="docutils literal notranslate"><span class="pre">list.f90</span></code> )は少し長くなるのでここには掲載しないが，地道にポインタを使ってアドレスを付け替えたりするだけである．以下の例は <code class="docutils literal notranslate"><span class="pre">list.f90</span></code> で実装したモジュール <code class="docutils literal notranslate"><span class="pre">mod_list</span></code> の使い方を示している．リストの伸長は <code class="docutils literal notranslate"><span class="pre">append</span></code>，要素の挿入は <code class="docutils literal notranslate"><span class="pre">insert</span></code>，削除は <code class="docutils literal notranslate"><span class="pre">remove</span></code> を用いてなどのモジュール内部手続きによって行うことが出来る．なお10行目ではモジュール内で定義した代入演算子を用いてリストを配列によって初期化している．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">program </span><span class="n">sample</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">use </span><span class="n">mod_list</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  type</span><span class="p">(</span><span class="n">list_type</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="k">nullify</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;initialize : &#39;</span>
<span class="linenos">10</span><span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos">11</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;append 2 : &#39;</span>
<span class="linenos">14</span><span class="w">  </span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">15</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;append 3 : &#39;</span>
<span class="linenos">18</span><span class="w">  </span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">19</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;insert -1 at 1 : &#39;</span>
<span class="linenos">22</span><span class="w">  </span><span class="k">call </span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">23</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;insert -2 at 3 : &#39;</span>
<span class="linenos">26</span><span class="w">  </span><span class="k">call </span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">27</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;remove at 1 : &#39;</span>
<span class="linenos">30</span><span class="w">  </span><span class="k">call </span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">31</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;remove at 3 : &#39;</span>
<span class="linenos">34</span><span class="w">  </span><span class="k">call </span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">35</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a20)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;delete : &#39;</span>
<span class="linenos">38</span><span class="w">  </span><span class="k">call </span><span class="n">delete</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">39</span><span class="w">  </span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="k">end program </span><span class="n">sample</span>
</pre></div>
</div>
<p>このプログラムの実行結果は以下のようになる．正しくリストの操作が出来ていることが分かるかと思う．</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>./a.out
<span class="linenos">2</span><span class="w">     </span>initialize<span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">    </span><span class="m">1</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">3</span><span class="w">       </span>append<span class="w"> </span><span class="m">2</span><span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">2</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">4</span><span class="w">       </span>append<span class="w"> </span><span class="m">3</span><span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">    </span><span class="m">1</span><span class="w">     </span><span class="m">2</span><span class="w">     </span><span class="m">3</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">5</span><span class="w"> </span>insert<span class="w"> </span>-1<span class="w"> </span>at<span class="w"> </span><span class="m">1</span><span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">   </span>-1<span class="w">     </span><span class="m">1</span><span class="w">     </span><span class="m">2</span><span class="w">     </span><span class="m">3</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">6</span><span class="w"> </span>insert<span class="w"> </span>-2<span class="w"> </span>at<span class="w"> </span><span class="m">3</span><span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">   </span>-1<span class="w">     </span><span class="m">1</span><span class="w">    </span>-2<span class="w">     </span><span class="m">2</span><span class="w">     </span><span class="m">3</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">7</span><span class="w">    </span>remove<span class="w"> </span>at<span class="w"> </span><span class="m">1</span><span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">    </span><span class="m">1</span><span class="w">    </span>-2<span class="w">     </span><span class="m">2</span><span class="w">     </span><span class="m">3</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">8</span><span class="w">    </span>remove<span class="w"> </span>at<span class="w"> </span><span class="m">3</span><span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">    </span><span class="m">1</span><span class="w">    </span>-2<span class="w">     </span><span class="m">3</span><span class="w"> </span><span class="o">]</span>
<span class="linenos">9</span><span class="w">         </span>delete<span class="w"> </span>:<span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
</pre></div>
</div>
<p>ここではリストの実装例を見たが，他にもキュー(queue)やスタック(stack)，ツリー(tree)，ハッシュ(hash)などがよく用いられるデータ構造の例として挙げられる．(これらはあくまでも大まかな分類であり，それぞれに対して更に細かい種類がある．例えば単にリストと言っても，片方向リストや双方向リスト，線形リストや循環リストなどの種類が存在する．)</p>
<p>ただし，大規模な数値計算においてこのようなデータ構造が用いられることはあまり多くない．なぜなら一般に柔軟なデータ構造を用いる処理は単純な配列に比べて効率が悪いためである．大規模数値シミュレーションではパフォーマンスが非常に重要となってくるため，複雑なデータ構造は極力使わずに実装される．しかし，配列では実装しづらい複雑なアルゴリズムを用いる必要がある場合にはデータ構造の知識も重要になってくるかもしれないので，興味のある人は勉強してみて欲しい．なおC++を始めとする多くの言語において，<strong>データ構造を扱う標準ライブラリ</strong> (組込み関数のようなもの)が存在している．従って，複雑なデータ構造の扱いが必要な場合には大人しくFortranを使うのは諦めて，他の言語を用いることを推奨する．パフォーマンスが必要な場合にはC++など，そうでないならPythonなどを使うことで開発効率が格段に向上するであろう．</p>
</section>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">10.5. </span>デバッグのテクニック <sup>†</sup></a><a class="headerlink" href="#id17" title="Link to this heading"></a></h2>
<section id="id18">
<h3><span class="section-number">10.5.1. </span>プリプロセッサ<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<p>プログラムの開発中(デバッグ中)には一時的にソースコードの一部分をコメントアウトしてその影響を調べたいことが多々あるかと思う．このような時にプリプロセッサと呼ばれる機能を用いると便利である．プリプロセッサとはC/C++のコンパイラが自動的に行う前処理のことであるが，Fortranコンパイラでも多くの場合オプションによってプリプロセッサを有効にすることが出来る．なお，プリプロセッサを使うにはgfortranであれば <code class="docutils literal notranslate"><span class="pre">-cpp</span></code> オプション <a class="footnote-reference brackets" href="#id31" id="id19" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a> を付けてコンパイルすれば良い．または拡張子を <code class="docutils literal notranslate"><span class="pre">.f90</span></code> では無く <code class="docutils literal notranslate"><span class="pre">.F90</span></code> とすればオプションを指定しなくても自動的にプリプロセッサが有効になる．</p>
<p>プリプロセッサの機能は様々であるが，特に簡単で便利なのは以下の様な使い方である．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#if 0</span>
<span class="linenos">2</span><span class="w">  </span><span class="err">ここはコンパイラに無視されるので何が書いてあっても良い</span>
<span class="linenos">3</span><span class="cp">#endif</span>
</pre></div>
</div>
<p>一時的に実行させたく無い処理については，上の例のように <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">0</span></code> から <code class="docutils literal notranslate"><span class="pre">#endif</span></code> によって囲むことでコンパイラにその部分を無視させることが出来る．コンパイラに認識させたい時には <code class="docutils literal notranslate"><span class="pre">0</span></code> を <code class="docutils literal notranslate"><span class="pre">1</span></code> に変更するだけで良いので，特定の処理が結果に与える影響を簡単に調べることが出来る．さらに</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#if 1</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">処理A</span>
<span class="linenos">3</span><span class="cp">#else</span>
<span class="linenos">4</span><span class="w">  </span><span class="n">処理B</span>
<span class="linenos">5</span><span class="cp">#endif</span>
</pre></div>
</div>
<p>としておけば，<code class="docutils literal notranslate"><span class="pre">1</span></code> の時には処理A，<code class="docutils literal notranslate"><span class="pre">0</span></code> の時には処理Bをそれぞれコンパイルさせる事が出来る．</p>
<p>プリプロセッサは基本的にC言語で用いられるものと同じなので，<strong>マクロ</strong> という機能も用いることが出来る．例えば</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#ifdef _DEBUG</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">デバッグ処理</span>
<span class="linenos">3</span><span class="cp">#endif</span>
</pre></div>
</div>
<p>となっている場合に</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>-cpp<span class="w"> </span>-D_DEBUG<span class="w"> </span>sample.f90
</pre></div>
</div>
<p>とすれば&quot;デバッグ処理&quot;がコンパイルされる．ここで <code class="docutils literal notranslate"><span class="pre">-D_DEBUG</span></code> は <code class="docutils literal notranslate"><span class="pre">_DEBUG</span></code> というマクロを定義するという意味である．マクロを用いたプリプロセッサには様々な機能があり，より複雑な指定も可能である．</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#if   _DEBUG_MODE == 0</span>
<span class="linenos">2</span><span class="w">  </span><span class="n">デバッグモード0</span>
<span class="linenos">3</span><span class="cp">#elif _DEBUG_MODE == 1</span>
<span class="linenos">4</span><span class="w">  </span><span class="n">デバッグモード1</span>
<span class="linenos">5</span><span class="cp">#elif _DEBUG_MODE == 2</span>
<span class="linenos">6</span><span class="w">  </span><span class="n">デバッグモード2</span>
<span class="linenos">7</span><span class="cp">#endif</span>
</pre></div>
</div>
<p>のような場合には，<code class="docutils literal notranslate"><span class="pre">_DEBUG_MODE</span></code> という名前のマクロの値 <a class="footnote-reference brackets" href="#id32" id="id20" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> によってコンパイルする処理を切り替えることが出来る．マクロの値もコマンドラインから明示的に与えることが出来る．例えば</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>gfortran<span class="w"> </span>-cpp<span class="w"> </span>-D_DEBUG_MODE<span class="o">=</span><span class="m">1</span><span class="w"> </span>sample.f90
</pre></div>
</div>
<p>のように実行すれば，マクロ <code class="docutils literal notranslate"><span class="pre">_DEBUG_MODE</span></code> の値が1に定義され，&quot;デバッグモード1&quot;の処理がコンパイルされる．</p>
</section>
<section id="printf">
<h3><span class="section-number">10.5.2. </span>printfデバッグ<a class="headerlink" href="#printf" title="Link to this heading"></a></h3>
<p>デバッグの基本中の基本テクニックは <code class="docutils literal notranslate"><span class="pre">printf</span></code> デバッグと呼ばれる．<code class="docutils literal notranslate"><span class="pre">printf</span></code> とはC言語で標準出力に表示するための関数名で，要するに間違っていそうな箇所に当たりをつけて，途中結果を出力して確認するという古典的な手法である．Fortranの場合にはひたすら <code class="docutils literal notranslate"><span class="pre">write(*,*)</span></code> で怪しい変数を出力してみれば大抵の場合(すくなくとも演習の課題レベルの場合)には自ずとバグの原因が見えてくる <a class="footnote-reference brackets" href="#id33" id="id21" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a>．</p>
<p>このデバッグ手法はプリプロセッサと組み合わせると便利である．例えば</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#ifdef _DEBUG</span>
<span class="linenos">2</span><span class="cp">#define DEBUG_PRINT(a) write(*,*) (a)</span>
<span class="linenos">3</span><span class="cp">#else</span>
<span class="linenos">4</span><span class="cp">#define DEBUG_PRINT(a)</span>
<span class="linenos">5</span><span class="cp">#endif</span>
</pre></div>
</div>
<p>としておくと，任意の場所で</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">DEBUG_PRINT</span><span class="p">(</span><span class="n">出力したい変数</span><span class="p">)</span>
</pre></div>
</div>
<p>のように <code class="docutils literal notranslate"><span class="pre">DEBUG_PRINT</span></code> というマクロを関数(サブルーチン)のように用いることが出来る．この時，コンパイル時にオプション <code class="docutils literal notranslate"><span class="pre">-D_DEBUG</span></code> を付けると <code class="docutils literal notranslate"><span class="pre">DEBUG_PRINT</span></code> の引数に与えた変数の値が出力されるが，<code class="docutils literal notranslate"><span class="pre">-D_DEBUG</span></code> を付けなければ何も出力されない．つまり，この形式でデバッグメッセージを埋め込んでおけば，ソースコードを一切修正することなく，コマンドラインのみでデバッグモードに切り替えることが出来る．
(これは <code class="docutils literal notranslate"><span class="pre">_DEBUG</span></code> というマクロが定義されている場合には，<code class="docutils literal notranslate"><span class="pre">DEBUG_PRINT(x)</span></code> が <code class="docutils literal notranslate"><span class="pre">write(*,*)</span> <span class="pre">(x)</span></code> に変換され，それ以外の場合は単なるホワイトスペース(空白)に変換されるためである．)</p>
<p>このようなテクニックは非常に有用で，開発効率を大幅に高めてくれるハズなので，少しずつ身につけていくと良い．</p>
</section>
<section id="gdb">
<h3><span class="section-number">10.5.3. </span>gdb<a class="headerlink" href="#gdb" title="Link to this heading"></a></h3>
<p>To be written.</p>
</section>
</section>
<section id="c">
<h2><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">10.6. </span>C言語とのリンク <sup>†</sup></a><a class="headerlink" href="#c" title="Link to this heading"></a></h2>
<p>To be written.</p>
</section>
<section id="fortran-77">
<h2><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">10.7. </span>Fortran 77について <sup>†</sup></a><a class="headerlink" href="#fortran-77" title="Link to this heading"></a></h2>
<p>To be written.</p>
</section>
<section id="id22">
<h2><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">10.8. </span>第10章 演習課題</a><a class="headerlink" href="#id22" title="Link to this heading"></a></h2>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<ul class="simple">
<li><p><a class="reference internal" href="chap10_kadai2_f90.html"><span class="doc">課題2 解答例</span></a></p></li>
<li><p><a class="reference internal" href="chap10_kadai3_f90.html"><span class="doc">課題3 解答例</span></a></p></li>
</ul>
</div>
<section id="id23">
<h3><span class="section-number">10.8.1. </span>課題1<a class="headerlink" href="#id23" title="Link to this heading"></a></h3>
<p>サンプルプログラムをコンパイル・実行して動作を確認せよ．さらに，適宜修正してその実行結果を確認せよ．</p>
</section>
<section id="id24">
<h3><span class="section-number">10.8.2. </span>課題2<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<p>任意の1変数関数 <span class="math notranslate nohighlight">\(f(x)\)</span> およびその微分値を返す関数 <span class="math notranslate nohighlight">\(f'(x)\)</span> を引数として受け取り， <span class="math notranslate nohighlight">\(f(x) = 0\)</span> の近似解をNewton法により求めるサブルーチンを実装し，その動作を確認せよ．ただし以下の条件を満たすこと．</p>
<ul class="simple">
<li><p>初期値を引数として受け取る．</p></li>
<li><p>無限ループにならないように最大の反復回数を引数として受け取る．</p></li>
<li><p>許容誤差を引数として受け取り,
反復による近似解の変化が許容誤差以下となったら収束したとみなす．</p></li>
<li><p>収束判定のステータスを返す．</p></li>
<li><p>求まった近似解を返す(収束しなかった場合は最後の反復後の解の近似値)．</p></li>
</ul>
<p>(二分法のモジュール <code class="docutils literal notranslate"><span class="pre">bisection.f90</span></code> の <code class="docutils literal notranslate"><span class="pre">mod_bisection</span></code> を参考にすればよい．)</p>
</section>
<section id="id25">
<h3><span class="section-number">10.8.3. </span>課題3 <sup>†</sup><a class="headerlink" href="#id25" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">list.f90</span></code> で定義されているリストを実装したモジュール <code class="docutils literal notranslate"><span class="pre">mod_list</span></code> へ以下の様な機能追加を試みよ．以下では <code class="docutils literal notranslate"><span class="pre">a</span></code> はリスト( <code class="docutils literal notranslate"><span class="pre">type(list_type)</span></code>)のポインタであるとする．</p>
<ul class="simple">
<li><p>代入演算子が配列を受け取れるようにせよ．即ち，</p></li>
</ul>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="p">)</span>
</pre></div>
</div>
<p>のようにリストに配列を代入すると元のリストを破棄し(正しく <code class="docutils literal notranslate"><span class="pre">deallocate</span></code> し)，与えられた配列でリストを初期化すること．</p>
<ul class="simple">
<li><p>サンプルでは <code class="docutils literal notranslate"><span class="pre">append</span></code> によって単一の値をリストの終端に追加しているが，配列を与えた場合にはその各要素をリストに追加するように拡張せよ．ただしオーバーロードを用いることで，どちらも同じサブルーチン名 <code class="docutils literal notranslate"><span class="pre">append</span></code> で行うようにせよ．</p></li>
</ul>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">2</span><span class="k">call </span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">/</span><span class="p">))</span>
</pre></div>
</div>
<p>のようなコードが実行可能となるはずである．</p>
<ul class="simple">
<li><p>同様にinsertでも配列を追加できるようにせよ．</p></li>
</ul>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">call </span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">2</span><span class="k">call </span><span class="n">insert</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">/-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="p">))</span>
</pre></div>
</div>
<p>のようなコードが実行可能となるはずである．</p>
<hr class="docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id26" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">1</a><span class="fn-bracket">]</span></span>
<p>これはFortranの規格というわけではないようだが，多くのコンパイラがこのような仕様になっている．</p>
</aside>
<aside class="footnote brackets" id="id27" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">2</a><span class="fn-bracket">]</span></span>
<p>C言語のインクルードパスの指定と同じである．</p>
</aside>
<aside class="footnote brackets" id="id28" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id10">3</a><span class="fn-bracket">]</span></span>
<p>単に <code class="docutils literal notranslate"><span class="pre">time</span></code> とするとシェルの組込みコマンドになってしまうので，<code class="docutils literal notranslate"><span class="pre">/usr/bin/time</span></code> と絶対パスを指定している．シェル組込みの <code class="docutils literal notranslate"><span class="pre">time</span></code> でも問題は無いが，出力が多少異なるであろう．</p>
</aside>
<aside class="footnote brackets" id="id29" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id13">4</a><span class="fn-bracket">]</span></span>
<p>C言語のポインタと異なり，<code class="docutils literal notranslate"><span class="pre">=&gt;</span></code> でポインタのアドレスを指定する以外は普通の変数のように使える．これによってポインタであることを意識せずに用いることが出来る．個人的には逆に分かりにくいように思うのだが．</p>
</aside>
<aside class="footnote brackets" id="id30" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">5</a><span class="fn-bracket">]</span></span>
<p>ただしポインタ配列の場合は <code class="docutils literal notranslate"><span class="pre">allocatable</span></code> とは異なり，スコープから外れた場合に自動で <code class="docutils literal notranslate"><span class="pre">deallocate</span></code> されないようである．</p>
</aside>
<aside class="footnote brackets" id="id31" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">6</a><span class="fn-bracket">]</span></span>
<p>ifortでは <code class="docutils literal notranslate"><span class="pre">-fpp</span></code>．</p>
</aside>
<aside class="footnote brackets" id="id32" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id20">7</a><span class="fn-bracket">]</span></span>
<p>変数のように見えるが，プリプロセッサで(コンパイルされる前に)処理されるのでプログラム中の変数にはなっていない．</p>
</aside>
<aside class="footnote brackets" id="id33" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">8</a><span class="fn-bracket">]</span></span>
<p>演習中にディスプレイの前でフリーズしている人を良く見かけるが，考えているだけでは何も進まない．とりあえずヒントを探すという意味で値を出力するのは非常に重要である．</p>
</aside>
</aside>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="chap09.html" class="btn btn-neutral float-left" title="9. モジュールと構造型" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Takanobu Amano.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>