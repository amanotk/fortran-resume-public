

<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9. モジュールと構造型 &mdash; Fortran演習(地球惑星物理学演習)</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5349f25f" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=9f0ccda0" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=528de7ef"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=4755f45a"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="10. 付録" href="chap10.html" />
    <link rel="prev" title="8. 数値解析の基礎" href="chap08.html" />
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.18.1/build/cssreset/cssreset-min.css">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99010794-2', 'auto');
  ga('send', 'pageview');

</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Fortran演習
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chap01.html">1. はじめに</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">2. プログラムの作成と実行</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">3. 変数・データ型・基本的な計算</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">4. 制御構造</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap05.html">5. 配列</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">6. 書式指定・ファイル入出力・文字列処理</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">7. 関数とサブルーチン</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">8. 数値解析の基礎</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">9. モジュールと構造型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id3">9.1. モジュールの基本</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c9-refer-variables">9.2. 変数や定数の参照</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c9-internal-procedure">9.3. 内部手続き</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">9.4. 総称名</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">9.5. アクセス制限</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">9.5.1. 参照先からのアクセス制限</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">9.5.2. 参照元からのアクセス制限</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#c9-structure">9.6. 構造型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">9.6.1. 定義と使い方</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">9.6.2. ユーザー定義演算子</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">9.6.3. ユーザー定義代入文</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id19">9.7. 第9章 演習課題</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id20">9.7.1. 課題1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id21">9.7.2. 課題2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">9.7.3. 課題3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id23">9.7.4. 課題4</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">9.7.5. 課題5</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">10. 付録</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Fortran演習</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">9. </span>モジュールと構造型</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">9. </span>モジュールと構造型</a><a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<p>これまでに既に <a class="reference internal" href="chap07.html#c7"><span class="std std-ref">関数とサブルーチン</span></a> ではプログラムの開発を容易にするための手段として，関数やサブルーチンといったサブプログラムを用いる方法を学んだ．これらサブプログラムは機能を分割し，1つの独立したプログラム単位として扱われる．ところがプログラムの規模が大きくなってくると，関数やサブルーチン群を用いるだけでは必ずしも十分とは言えなくなって来る．そのような場合に便利になってくる <strong>モジュール</strong> という機能について学ぼう．</p>
<p>モジュールも独立したサブプログラムであるが，関数やサブルーチンなどよりも <strong>1段階大きなプログラム単位</strong> として考えることができる．すなわち，複数の関連する機能を提供する関数やサブルーチン群を1つのモジュールにまとめて提供することが出来る．さらに関数やサブルーチンと大きく異なり，モジュール内部に宣言された変数に外部からアクセスすることも出来るため，複数の変数群をまとめる役割も果たす．またモジュールと共に用いると便利な <strong>構造型</strong> の使い方も身につけよう．構造型はいくつかのデータを1つにまとめて，新しいユーザー定義型を提供する機能である．</p>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<ul class="simple">
<li><p><a class="reference internal" href="chap09_sample1_f90.html"><span class="doc">sample1.f90</span></a> : 定数や変数の参照</p></li>
<li><p><a class="reference internal" href="chap09_sample2_f90.html"><span class="doc">sample2.f90</span></a> : 内部手続き</p></li>
<li><p><a class="reference internal" href="chap09_sample3_f90.html"><span class="doc">sample3.f90</span></a> : 総称名</p></li>
<li><p><a class="reference internal" href="chap09_sample4_f90.html"><span class="doc">sample4.f90</span></a> : アクセス制限</p></li>
<li><p><a class="reference internal" href="chap09_sample5_f90.html"><span class="doc">sample5.f90</span></a> : 構造型と演算子オーバーロード</p></li>
</ul>
</div>
<nav class="contents" id="id2">
<p class="topic-title">この章の内容</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id30">モジュールと構造型</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id31">モジュールの基本</a></p></li>
<li><p><a class="reference internal" href="#c9-refer-variables" id="id32">変数や定数の参照</a></p></li>
<li><p><a class="reference internal" href="#c9-internal-procedure" id="id33">内部手続き</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id34">総称名</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id35">アクセス制限</a></p></li>
<li><p><a class="reference internal" href="#c9-structure" id="id36">構造型</a></p></li>
<li><p><a class="reference internal" href="#id19" id="id37">第9章 演習課題</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="id3">
<h2><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">9.1. </span>モジュールの基本</a><a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<p>既に述べたようにモジュールは1つの独立したプログラム単位である．その特徴は以下の様な点である．</p>
<ul class="simple">
<li><p>モジュール内で変数宣言が出来る．宣言された変数はモジュール内部からはもちろん他のモジュールやメインプログラムから使用することが出来る．</p></li>
<li><p>複数の関数やサブルーチンをモジュール内で内部手続きとして定義することが出来る．内部手続きはモジュール内部の他の内部手続きや，モジュール外部から呼び出すことも出来る．</p></li>
</ul>
<p>モジュールの定義は以下のような形で行う．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">name_of_module</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="c">! 変数宣言など</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">contains</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="c">! 内部手続きの定義</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">end module </span><span class="n">name_of_module</span>
</pre></div>
</div>
<p>モジュールの構造はメインプログラムと非常に似ており，<code class="docutils literal notranslate"><span class="pre">module</span></code> で始まり，<code class="docutils literal notranslate"><span class="pre">end</span> <span class="pre">module</span></code> で終わる．また内部手続きは <code class="docutils literal notranslate"><span class="pre">contains</span></code> から <code class="docutils literal notranslate"><span class="pre">end</span> <span class="pre">module</span></code> の間に定義する．ただしメインプログラムに記述されたコードは上から順に実行されていくのに対して，モジュール内( <code class="docutils literal notranslate"><span class="pre">implicit</span> <span class="pre">none</span></code> から <code class="docutils literal notranslate"><span class="pre">contains</span></code> までの間)には実行文は記述せず，変数宣言などを行うだけである．内部手続きについても明示的に呼び出されない限りは実行されることは無い．</p>
<p>定義したモジュールはメインプログラムや，サブルーチン，関数，または他のモジュールから参照して用いることが出来る．使い方は <code class="docutils literal notranslate"><span class="pre">implicit</span> <span class="pre">none</span></code> を記述する前に <code class="docutils literal notranslate"><span class="pre">use</span></code> によって使いたいモジュールを記述するだけである．</p>
<p>例えばメインプログラムからモジュールを使用するには</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">program </span><span class="n">name_of_program</span>
<span class="linenos">2</span><span class="w">  </span><span class="k">use </span><span class="n">name_of_module</span>
<span class="linenos">3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="w">  </span><span class="c">! メインプログラムの処理</span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="k">end program </span><span class="n">name_of_program</span>
</pre></div>
</div>
<p>というような形となる．</p>
</section>
<section id="c9-refer-variables">
<span id="id4"></span><h2><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">9.2. </span>変数や定数の参照</a><a class="headerlink" href="#c9-refer-variables" title="Link to this heading"></a></h2>
<blockquote>
<div><p><a class="reference internal" href="chap09_sample1_f90.html"><span class="doc">サンプルコード参照</span></a></p>
</div></blockquote>
<p>モジュールを用いると変数や定数の宣言を共通化し，異なるモジュールやメインプログラムから利用することが出来る．大規模プログラムで共通の変数が複数のモジュールなどから参照される場合には変数宣言を共通化しておくと良い．具体的には以下の例の様になる．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! モジュールの定義</span>
<span class="linenos"> 2</span><span class="k">module </span><span class="n">mod_variable</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="c">! 定数の定義</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">light_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.998e+08</span><span class="w"> </span><span class="c">! 光速 [m/s]</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kboltzmann</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">1.381e-23</span><span class="w"> </span><span class="c">! Boltzmann定数 [J/K]</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hplanck</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">6.626e-34</span><span class="w"> </span><span class="c">! Planck定数 [J s]</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">  </span><span class="c">! 変数</span>
<span class="linenos">11</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">end module </span><span class="n">mod_variable</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c">! メインプログラム</span>
<span class="linenos">16</span><span class="k">program </span><span class="n">sample</span>
<span class="linenos">17</span><span class="w">  </span><span class="k">use </span><span class="n">mod_variable</span>
<span class="linenos">18</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">  </span><span class="c">! 定数の値は参照のみ可能</span>
<span class="linenos">21</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a20, &quot;:&quot;, e12.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;speed of light&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">light_speed</span>
<span class="linenos">22</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a20, &quot;:&quot;, e12.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Boltzmann constant&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">kboltzmann</span>
<span class="linenos">23</span><span class="w">  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a20, &quot;:&quot;, e12.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Planck constant&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">hplanck</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">  </span><span class="c">! これはできない(コンパイルエラー)</span>
<span class="linenos">26</span><span class="w">  </span><span class="c">!light_speed = 1.0_8</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">  </span><span class="c">! 変数の値は変更可能</span>
<span class="linenos">29</span><span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="linenos">30</span><span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="linenos">31</span><span class="w">  </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">  </span><span class="k">stop</span>
<span class="linenos">34</span><span class="k">end program </span><span class="n">sample</span>
</pre></div>
</div>
<p>プログラム実行中に常にどこからでもアクセスできる変数を <strong>グローバル変数</strong>，サブルーチンや関数の内部でしか用いない変数を <strong>ローカル変数</strong> などと呼ぶことがある．上の例ではモジュールの内部変数がグローバル変数として用いられている．この例のように，一般にはモジュール変数をグローバル変数として用いるには <code class="docutils literal notranslate"><span class="pre">save</span></code> 属性を付けておく方が良い．例えば上の例で変数 <code class="docutils literal notranslate"><span class="pre">x</span></code>，<code class="docutils literal notranslate"><span class="pre">y</span></code>，<code class="docutils literal notranslate"><span class="pre">z</span></code> の宣言を</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span>
</pre></div>
</div>
<p>としてしまうと，複数のサブルーチンや関数などから <code class="docutils literal notranslate"><span class="pre">use</span></code> で参照される場合に，その都度これらの値が書き換えられてしまう(初期化される)可能性がある．(例えばメインプログラムから1度だけ <code class="docutils literal notranslate"><span class="pre">use</span></code> で参照される場合にはこのような問題は生じない．) 最近のコンパイラは自動でモジュール内変数に <code class="docutils literal notranslate"><span class="pre">save</span></code> 属性が指定されたものと扱う場合が多いようなので，これは必ずしも必須ではないかもしれない．ただしコンパイラ依存性を無くし，移植性の高いプログラムとするためには指定しておいた方が無難であろう．なお，いずれにせよ定数変数については参照されるだけなので <code class="docutils literal notranslate"><span class="pre">save</span></code> 属性は必要ない．</p>
<p>一般に，プログラムが複雑化して来ると <strong>グローバル変数がバグの原因</strong> になりやすくなるため，使わない方が良いとされている．グローバル変数を一切使わない場合にはメインプログラムで全ての変数を宣言し，必要な変数を各サブルーチンや関数へ全て引数として渡せば良い．この場合にはデータの受け渡しが明示的に行われるので，意図せずデータが変更されるのを防ぐことが出来る．ただしこれはあくまで一般論であり，いつでもグローバル変数の使用を避けるべきというわけではない．比較的単純で，データの受け渡しを間違いそうに無いようなプログラム(比較的小規模の数値シミュレーションコードはこれに当てはまる場合が多い)であればグローバル変数を用いた方がスッキリ書けるような場合も多い．ただし，この場合でもグローバル変数にしても問題無い変数と，ローカル変数にすべき変数はよく考えて区別しておいた方が良い．何でもかんでもグローバル変数にしてしまうと汎用性の無いプログラムになってしまい，仕様変更に伴うプログラムの修正が非常に困難になる．</p>
<p>例えば以下の例を考えよう．ここでは変数 <code class="docutils literal notranslate"><span class="pre">i</span></code> をモジュール <code class="docutils literal notranslate"><span class="pre">mod_global</span></code> 内で定義されたグローバル変数として用いている．メインプログラムの内部手続きとして定義されたサブルーチン <code class="docutils literal notranslate"><span class="pre">sub</span></code> 内の <code class="docutils literal notranslate"><span class="pre">do</span></code> ループでも，メインプログラムでも変数 <code class="docutils literal notranslate"><span class="pre">i</span></code> をループ変数として用いている．<code class="docutils literal notranslate"><span class="pre">gfortran</span></code> でこのプログラムをコンパイルして実行すると，無限ループになってしまうようである(この動作はコンパイラに依存するかもしれないが，いずれにせよ「意図した通り」には動かない)．これはメインプログラムから <code class="docutils literal notranslate"><span class="pre">sub</span></code> を3回呼び出すつもりでも，<code class="docutils literal notranslate"><span class="pre">sub</span></code> 内部で変数 <code class="docutils literal notranslate"><span class="pre">i</span></code> の値が更新され，メインプログラムの <code class="docutils literal notranslate"><span class="pre">do</span></code> ループの反復が正しく終了しないためであろう．これは極端な例ではあるが，特にループ変数のように不用意に使ってしまいそうな名前の変数はローカル変数にして，必要な場合にその都度宣言して用いる方が安全である．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">mod_global</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="c">! グローバル変数</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">end module </span><span class="n">mod_global</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">program </span><span class="n">main</span>
<span class="linenos">10</span><span class="w">  </span><span class="k">use </span><span class="n">mod_global</span>
<span class="linenos">11</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">  </span><span class="c">! グローバル変数iでループを回す</span>
<span class="linenos">14</span><span class="w">  </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">15</span><span class="w">     </span><span class="k">call </span><span class="n">sub</span><span class="p">()</span><span class="w"> </span><span class="c">! この中でiが更新されてしまう!!</span>
<span class="linenos">16</span><span class="w">  </span><span class="k">end do</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="k">  stop</span>
<span class="linenos">19</span><span class="k">contains</span>
<span class="linenos">20</span><span class="k">  subroutine </span><span class="n">sub</span><span class="p">()</span>
<span class="linenos">21</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">    </span><span class="c">! ここでもグローバル変数iでループを回す</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="linenos">25</span><span class="w">       </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">i</span>
<span class="linenos">26</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="k">  end subroutine </span><span class="n">sub</span>
<span class="linenos">29</span><span class="k">end program </span><span class="n">main</span>
</pre></div>
</div>
</section>
<section id="c9-internal-procedure">
<span id="id5"></span><h2><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">9.3. </span>内部手続き</a><a class="headerlink" href="#c9-internal-procedure" title="Link to this heading"></a></h2>
<blockquote>
<div><p><a class="reference internal" href="chap09_sample2_f90.html"><span class="doc">サンプルコード参照</span></a></p>
</div></blockquote>
<p>メインプログラムと同様に，モジュールにも内部手続きを定義することが可能であり，またモジュールの内部手続きからモジュール内で定義された変数には自由にアクセスすることが出来る(これもメインプログラムの内部手続きと同様である)．<code class="docutils literal notranslate"><span class="pre">use</span></code> でモジュールの使用を宣言すると，モジュールの変数だけでなく内部手続きも同様に用いることが出来る．このようにモジュールは関連する変数と手続きをまとめることが出来るため，サブルーチンや関数よりも大きなプログラム単位を提供することになる．</p>
<p>例えば以下のモジュール <code class="docutils literal notranslate"><span class="pre">mod_integrator</span></code> は予めサンプリングされた関数値の配列と刻み幅を受け取り，<a class="reference internal" href="chap08.html#c8-numerical-integration"><span class="std std-ref">数値積分</span></a> で扱った台形公式およびSimpsonの公式を用いて数値積分する関数を内部手続きとして実装したモジュールである．このように関連するサブプログラムをまとめてモジュールの内部手続きとして実装しておけば，<code class="docutils literal notranslate"><span class="pre">use</span> <span class="pre">mod_integrator</span></code> するだけで(外部手続きの時のように <code class="docutils literal notranslate"><span class="pre">interface</span></code> による準備をしなくても)安全に利用することが出来る．これから分かるように，<a class="reference internal" href="#c9-internal-procedure"><span class="std std-ref">内部手続き</span></a> で外部手続きを非推奨としたのは，単純に外部手続きを何らかのモジュールの中に入れて(内部手続きとして定義して)しまえば良いからである．これによって外部手続きの抱える問題は全て解決する．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">mod_integrator</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">contains</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="c">!</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="c">! 台形公式による数値積分</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="c">!</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">10</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">f</span><span class="p">(:)</span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dx</span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ret</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5_8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
<span class="linenos">20</span><span class="w">       </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">21</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">22</span><span class="k">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dx</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">  </span><span class="k">end function </span><span class="n">trapezoid</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">27</span><span class="w">  </span><span class="c">! Simpson公式による数値積分</span>
<span class="linenos">28</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">29</span><span class="w">  </span><span class="k">function </span><span class="n">simpson</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos">30</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">31</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">f</span><span class="p">(:)</span>
<span class="linenos">32</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dx</span>
<span class="linenos">33</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ret</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="c">! 端点を含めた配列サイズが奇数でなければエラー</span>
<span class="linenos">40</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">41</span><span class="k">       write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;array size must be odd&#39;</span>
<span class="linenos">42</span><span class="w">       </span><span class="k">stop</span>
<span class="linenos">43</span><span class="k">    end if</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="k">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">46</span><span class="w">    </span><span class="c">! even</span>
<span class="linenos">47</span><span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">48</span><span class="w">       </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">4.0_8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">49</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">50</span><span class="w">    </span><span class="c">! odd</span>
<span class="linenos">51</span><span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">52</span><span class="w">       </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0_8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">53</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">54</span><span class="k">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">3.0_8</span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="w">  </span><span class="k">end function </span><span class="n">simpson</span>
<span class="linenos">57</span><span class="k">end module </span><span class="n">mod_integrator</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">9.4. </span>総称名</a><a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<blockquote>
<div><p><a class="reference internal" href="chap09_sample3_f90.html"><span class="doc">サンプルコード参照</span></a></p>
</div></blockquote>
<p>これまでは何も意識せずに単精度で宣言された <code class="docutils literal notranslate"><span class="pre">x</span></code> に対しても，倍精度で宣言された <code class="docutils literal notranslate"><span class="pre">x</span></code> に対しても <code class="docutils literal notranslate"><span class="pre">sin(x)</span></code> のように型の精度を気にせず組み込み関数を呼び出しをしてきたことと思う．しかし自分で定義した関数やサブルーチンについては，正確に宣言した型を引数として呼び出す必要があった．実はその昔のFortran 77の時代には単精度に対して <code class="docutils literal notranslate"><span class="pre">sin(x)</span></code>，倍精度に対しては <code class="docutils literal notranslate"><span class="pre">dsin(x)</span></code> というように，組み込み関数にも精度ごとに異なる関数が用意されていて，手動で使い分ける必要があった(ここで <code class="docutils literal notranslate"><span class="pre">d</span></code> は倍精度を表すdoubleの意味である)．これでは明らかに不便である．</p>
<p>Fortran 90以降では，この問題を解決するために，内部手続きに対して総称名(オーバーロード)という便利な機能を用いることが出来るようになった <a class="footnote-reference brackets" href="#id25" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>．これを用いると，呼び出し形式(引数の数や型)が異なる複数の関数やサブルーチンを同じ名前で呼び出すことが出来る．先ほどの <code class="docutils literal notranslate"><span class="pre">sin(x)</span></code> の例で言えば，引数 <code class="docutils literal notranslate"><span class="pre">x</span></code> が単精度実数であれば単精度版を，倍精度であれば倍精度版の関数を自動的に選択して呼び出すことになる．自分で定義した関数やサブルーチンについても，この総称名の機能を用いることが出来る．</p>
<p>これにはモジュールの変数宣言部分で</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">interface </span><span class="n">generic_procedure</span>
<span class="linenos">2</span><span class="w">  </span><span class="k">module procedure </span><span class="n">specific_procedure1</span><span class="p">,</span><span class="w"> </span><span class="n">specific_procedure2</span>
<span class="linenos">3</span><span class="k">end interface </span><span class="n">generic_procedure</span>
</pre></div>
</div>
<p>のように <code class="docutils literal notranslate"><span class="pre">interface</span></code> を用いて総称名を宣言すれば良い．個別名としては呼び出し形式の異なる(形式が同じだとコンパイラが判別出来ない!)複数の関数やサブルーチンをカンマで区切って記述する．これによって複数のルーチンを単一の名前で呼び出すことが出来る．(上の例の場合は総称名 <code class="docutils literal notranslate"><span class="pre">generic_procedure</span></code> によって <code class="docutils literal notranslate"><span class="pre">specific_procedure1</span></code> や <code class="docutils literal notranslate"><span class="pre">specific_procedure2</span></code> を呼び出す．)コンパイラは総称名で呼び出されたルーチンについて，その呼び出し形式に応じて自動的に適切なものを選択する．具体的な使い方は以下の例を見て欲しい．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! 面積を計算するモジュール</span>
<span class="linenos"> 2</span><span class="k">module </span><span class="n">mod_area</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="nb">atan</span><span class="p">(</span><span class="mf">1.0_8</span><span class="p">)</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="c">! 総称名を定義</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="k">interface </span><span class="n">triangle</span>
<span class="linenos"> 9</span><span class="w">     </span><span class="k">module procedure </span><span class="n">triangle1</span><span class="p">,</span><span class="w"> </span><span class="n">triangle2</span>
<span class="linenos">10</span><span class="w">  </span><span class="k">end interface </span><span class="n">triangle</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">contains</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">  </span><span class="c">! 底辺と高さが与えられた時の面積の計算</span>
<span class="linenos">15</span><span class="w">  </span><span class="k">function </span><span class="n">triangle1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
<span class="linenos">16</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>
<span class="linenos">17</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">area</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">  </span><span class="k">end function </span><span class="n">triangle1</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="w">  </span><span class="c">! 3つの頂点の座標が与えられた時の面積の計算</span>
<span class="linenos">24</span><span class="w">  </span><span class="k">function </span><span class="n">triangle2</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">y3</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
<span class="linenos">25</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">y3</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">area</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y3</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">x3</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="w">  </span><span class="k">end function </span><span class="n">triangle2</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="k">end module </span><span class="n">mod_area</span>
</pre></div>
</div>
<p>この例では三角形の面積を底辺と高さが与えられた時と3つの頂点の座標が与えられた時のいずれも同じ関数名で呼び出すことが出来るように総称名 <code class="docutils literal notranslate"><span class="pre">triangle</span></code> を宣言している．2つの違いは呼び出し時の引数だけなので，呼び出される時の引数の個数や型によってコンパイラが自動的に適切な方を呼び出すことが出来る．なお，総称名を用いると全く別の機能を実装したものであってもまとめることが出来てしまうのだが，このような使い方は混乱の元になるだけであろう．総称名を使うのは意味的に同じ機能を持った関数やサブルーチンをまとめる時にのみにしておいた方が良い．</p>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">9.5. </span>アクセス制限</a><a class="headerlink" href="#id8" title="Link to this heading"></a></h2>
<blockquote>
<div><p><a class="reference internal" href="chap09_sample4_f90.html"><span class="doc">サンプルコード参照</span></a></p>
</div></blockquote>
<p>モジュールを用いるために <code class="docutils literal notranslate"><span class="pre">use</span></code> すると，モジュール内で定義された変数，関数，サブルーチンに自由にアクセスできるが，これは一般的にはあまり好ましいことでは無い．例えば，<a class="reference internal" href="#c9-refer-variables"><span class="std std-ref">変数や定数の参照</span></a> では不用意にグローバル変数を作るとバグの元になることを示した．これはモジュールの利用者がモジュール内部の詳細を知らないために起こる問題である．</p>
<p>しかし，そもそもモジュールを利用する側はモジュール内部の詳細について知らないことが一般的であるし，そうあってしかるべきである．すなわち，モジュールを提供する側はそのモジュールと外部のインターフェースのみを提供し，内部の実装の詳細については公開しないという立場を取る方が懸命である．これには主に以下の2つの理由が挙げられる．</p>
<ul class="simple">
<li><p>モジュールを利用する立場からは，モジュール内で定義された変数名などで名前空間が汚染されてしまい，同じ名前の変数やルーチンを宣言出来なくなる．</p></li>
<li><p>モジュールを提供する立場からは，モジュール内部で用いている変数などが不用意に変更されてしまう可能性がある．例えば何らかの状態を保持する変数が利用者から意図せず変更されてしまうと動作がおかしくなるかもしれない．</p></li>
</ul>
<p><a class="reference internal" href="chap07.html#c7"><span class="std std-ref">関数とサブルーチン</span></a> で学んだことは，それらをブラックボックスとして用いることで間違いを減らすことが出来るということであった．モジュールについても基本的に考え方は同じであって，せっかく機能を分割してモジュールを実装したのならば利用する時にはその中身のことは忘れたい．特に規模が大きなプログラムを複数人体制で開発する際には他人が実装したモジュールの中身など知る由も無いし，知りたくも無いであろう．いたずらに守備範囲を広げてエラーするくらいなら，狭くても良いから自分の守備範囲だけは死守する方が守りは固くなるのである．</p>
<section id="id9">
<h3><span class="section-number">9.5.1. </span>参照先からのアクセス制限<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<p>まずは参照先(モジュールの利用者の側)からのアクセス制限について学ぼう．一部の変数やルーチンへのアクセスしか必要無い場合には，<code class="docutils literal notranslate"><span class="pre">use</span></code> 宣言の際に <code class="docutils literal notranslate"><span class="pre">only</span></code> を用いてそれ以外の名前を参照先からは無効にする(見えないようにする)ことが出来る．例えば <a class="reference internal" href="#c9-refer-variables"><span class="std std-ref">変数や定数の参照</span></a> の <code class="docutils literal notranslate"><span class="pre">mod_variable</span></code> から <code class="docutils literal notranslate"><span class="pre">light_speed</span></code> だけを用いたい場合には</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">use </span><span class="n">mod_variable</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">light_speed</span>
</pre></div>
</div>
<p>のように <code class="docutils literal notranslate"><span class="pre">only</span> <span class="pre">:</span></code> に続けて必要な変数名やルーチン名をカンマで区切ってリストすれば良い．また <code class="docutils literal notranslate"><span class="pre">light_speed</span></code> を別名で使いたい場合には</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">use </span><span class="n">mod_variable</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">light_speed</span>
</pre></div>
</div>
<p>のようにすることで，<code class="docutils literal notranslate"><span class="pre">light_speed</span></code> の代わりに <code class="docutils literal notranslate"><span class="pre">c</span></code> という名前でアクセスすることが出来る．(ただしあくまで別名なので実態は``light_speed`` のままである．) これによって，例えばモジュール内部の変数と同じ名前の変数を参照先で使いたい場合に，名前の競合を避けることが出来る．</p>
</section>
<section id="id10">
<h3><span class="section-number">9.5.2. </span>参照元からのアクセス制限<a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<p>参照先からのアクセス制限は言わば性善説の立場に立ったアクセス制限である <a class="footnote-reference brackets" href="#id26" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>．それに対して，性悪説の立場に立った，モジュールを提供する側からのアクセス制限も可能である．</p>
<p>モジュール内部で宣言された変数やルーチンには <code class="docutils literal notranslate"><span class="pre">public</span></code> や <code class="docutils literal notranslate"><span class="pre">private</span></code> などの属性を与えることが出来，この属性によってアクセス制限をすることが出来る．すなわち，<code class="docutils literal notranslate"><span class="pre">private</span></code> 属性が指定された変数やルーチンはモジュール外からは直接見えず，内部からのみアクセスが可能になる．一方で，<code class="docutils literal notranslate"><span class="pre">public</span></code> 属性が指定されたものは公開され，外部から自由にアクセスすることが出来る．Fortranのモジュールでは <code class="docutils literal notranslate"><span class="pre">public</span></code> がデフォルトである．</p>
<p>原則としてモジュールの内部でしか用いられないものは外部には公開しない方が良い．例えば以下のモジュールを考えよう．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">module </span><span class="n">mod_sample</span>
<span class="linenos">2</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="k">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="k">end module </span><span class="n">mod_sample</span>
</pre></div>
</div>
<p>いかにも他で使いそうな <code class="docutils literal notranslate"><span class="pre">l</span></code>，<code class="docutils literal notranslate"><span class="pre">m</span></code>，<code class="docutils literal notranslate"><span class="pre">n</span></code> という変数をモジュール内で宣言している．例えばメインプログラムからこのモジュールを利用する際に，他の用途に使おうと思ってこれらと同じ名前の変数を宣言するとコンパイルエラーとなってしまう．実はコンパイルエラーを出してくれればまだ良い方なのであって，メインプログラムで変数宣言を忘れた場合にはこれらの変数が普通に使えてしまう．モジュールの変数だと意識して使っていれば問題は無いのだが，そんなことはお構いなしに全く違う用途に使って値を書き換えてしまうと，モジュール内部でこれらの変数に依存しているようなコードは動作がおかしくなってしまうかもしれない．公開する必要が無いものは予め非公開にしておけば，このような不用意なバグの混入を未然に防ぐことが出来るのである．<code class="docutils literal notranslate"><span class="pre">public</span></code> と <code class="docutils literal notranslate"><span class="pre">private</span></code> の指定方法はいくつかあって，個別に指定する場合は</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">private</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
</pre></div>
</div>
<p>のように変数宣言時に属性を指定することが出来る．または</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="k">private</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
</pre></div>
</div>
<p>のように別に指定することも可能である．なお，内部手続きの公開設定についても上の3行目のような形で手続名を並べれば良い．デフォルトで非公開としたい場合にはモジュール宣言の最初( <code class="docutils literal notranslate"><span class="pre">implicit</span> <span class="pre">none</span></code> の後)に <code class="docutils literal notranslate"><span class="pre">private</span></code> を指定しておけば，明示的に <code class="docutils literal notranslate"><span class="pre">public</span></code> 属性を付けない限りは非公開となる．実用的なプログラムではデフォルトを非公開の設定にし，必要な物だけに <code class="docutils literal notranslate"><span class="pre">public</span></code> 属性を指定することを強く推奨する．</p>
<p>以下は単位変換付きの物理定数モジュールの例である．デフォルトで <code class="docutils literal notranslate"><span class="pre">private</span></code> にすることでモジュール内部の変数には直接アクセス出来ないようし，その代わり必要な定数の値を返す関数を <code class="docutils literal notranslate"><span class="pre">public</span></code> にしてある．アクセスする手段(インターフェース)を敢えて限定することで，単位系のモード( <code class="docutils literal notranslate"><span class="pre">unit</span></code>)に応じて物理定数の値が自動的に切り替わるようになっている <a class="footnote-reference brackets" href="#id27" id="id12" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! 物理定数モジュール</span>
<span class="linenos"> 2</span><span class="k">module </span><span class="n">mod_const</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">  private</span><span class="w"> </span><span class="c">! デフォルトで非公開</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="c">! 単位選択フラグ: 1 =&gt; MKS, 2 =&gt; CGS</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pi</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="nb">atan</span><span class="p">(</span><span class="mf">1.0_8</span><span class="p">)</span>
<span class="linenos">10</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mu0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0e-7_8</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">  </span><span class="c">! MKS =&gt; CGS への変換ファクター</span>
<span class="linenos">13</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e+0_8</span>
<span class="linenos">14</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e+2_8</span>
<span class="linenos">15</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e+3_8</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">  </span><span class="c">! MKSで定義</span>
<span class="linenos">18</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mks_light_speed</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mf">2.997924e+8_8</span>
<span class="linenos">19</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mks_electron_mass</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">9.109382e-31_8</span>
<span class="linenos">20</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mks_elementary_charge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.602176e-19_8</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">  </span><span class="c">! これらのみ公開</span>
<span class="linenos">23</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">set_mks</span><span class="p">,</span><span class="w"> </span><span class="n">set_cgs</span>
<span class="linenos">24</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">light_speed</span><span class="p">,</span><span class="w"> </span><span class="n">electron_mass</span><span class="p">,</span><span class="w"> </span><span class="n">elementary_charge</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="k">contains</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">  </span><span class="c">! MKSモード</span>
<span class="linenos">29</span><span class="w">  </span><span class="k">subroutine </span><span class="n">set_mks</span><span class="p">()</span>
<span class="linenos">30</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="k">    </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos">33</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">set_mks</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">  </span><span class="c">! CGSモード</span>
<span class="linenos">36</span><span class="w">  </span><span class="k">subroutine </span><span class="n">set_cgs</span><span class="p">()</span>
<span class="linenos">37</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="k">    </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">40</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">set_cgs</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">  </span><span class="c">! 光速</span>
<span class="linenos">43</span><span class="w">  </span><span class="k">function </span><span class="n">light_speed</span><span class="p">()</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">44</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">45</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">48</span><span class="k">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mks_light_speed</span>
<span class="linenos">49</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">50</span><span class="k">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mks_light_speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">L</span><span class="o">/</span><span class="n">T</span>
<span class="linenos">51</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">52</span><span class="k">       call </span><span class="n">unit_error</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<span class="linenos">53</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="k">  end function </span><span class="n">light_speed</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">  </span><span class="c">! 電子質量</span>
<span class="linenos">58</span><span class="w">  </span><span class="k">function </span><span class="n">electron_mass</span><span class="p">()</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">59</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">60</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">63</span><span class="k">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mks_electron_mass</span>
<span class="linenos">64</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">65</span><span class="k">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mks_electron_mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span>
<span class="linenos">66</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">67</span><span class="k">       call </span><span class="n">unit_error</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<span class="linenos">68</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="k">  end function </span><span class="n">electron_mass</span>
<span class="linenos">71</span>
<span class="linenos">72</span><span class="w">  </span><span class="c">! 素電荷</span>
<span class="linenos">73</span><span class="w">  </span><span class="k">function </span><span class="n">elementary_charge</span><span class="p">()</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">74</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">75</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span>
<span class="linenos">76</span>
<span class="linenos">77</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">78</span><span class="k">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mks_elementary_charge</span>
<span class="linenos">79</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">80</span><span class="k">       </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mks_elementary_charge</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">light_speed</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">mu0</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">81</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">82</span><span class="k">       call </span><span class="n">unit_error</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<span class="linenos">83</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">84</span>
<span class="linenos">85</span><span class="k">  end function </span><span class="n">elementary_charge</span>
<span class="linenos">86</span>
<span class="linenos">87</span><span class="w">  </span><span class="c">! エラー</span>
<span class="linenos">88</span><span class="w">  </span><span class="k">subroutine </span><span class="n">unit_error</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="linenos">89</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">90</span><span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">u</span>
<span class="linenos">91</span>
<span class="linenos">92</span><span class="w">    </span><span class="c">! 標準エラー出力へ</span>
<span class="linenos">93</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;(a, i3)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Error: invalid unit &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">u</span>
<span class="linenos">94</span>
<span class="linenos">95</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">unit_error</span>
<span class="linenos">96</span>
<span class="linenos">97</span><span class="k">end module </span><span class="n">mod_const</span>
</pre></div>
</div>
</section>
</section>
<section id="c9-structure">
<span id="id13"></span><h2><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">9.6. </span>構造型</a><a class="headerlink" href="#c9-structure" title="Link to this heading"></a></h2>
<blockquote>
<div><p><a class="reference internal" href="chap09_sample5_f90.html"><span class="doc">サンプルコード参照</span></a></p>
</div></blockquote>
<p>これまで扱ってきた <code class="docutils literal notranslate"><span class="pre">integer</span></code> や <code class="docutils literal notranslate"><span class="pre">real</span></code> のような組込み型だけで無く，新しいデータ型を自分で定義して用いることもできる．これを <strong>構造型</strong> と呼ぶ <a class="footnote-reference brackets" href="#id28" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>．構造型は組込み型やその配列はもちろん他の構造型を要素に持つことも出来る．</p>
<section id="id15">
<h3><span class="section-number">9.6.1. </span>定義と使い方<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<p>構造型は以下の様な形式で定義される．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">name_of_type</span>
<span class="linenos">2</span><span class="w">  </span><span class="c">!型名 :: 要素名</span>
<span class="linenos">3</span><span class="w">  </span><span class="c">!の形で任意の変数を定義する</span>
<span class="linenos">4</span><span class="k">end type </span><span class="n">name_of_type</span>
</pre></div>
</div>
<p>組み込み型と同様に，定義した構造型の変数を以下のように宣言することによって使うことが出来る．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">type</span><span class="p">(</span><span class="n">name_of_type</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">name_of_variables</span>
</pre></div>
</div>
<p>例えば以下の例では，倍精度実数型の <code class="docutils literal notranslate"><span class="pre">x</span></code>，<code class="docutils literal notranslate"><span class="pre">y</span></code> を要素に持つ新しい構造型 <code class="docutils literal notranslate"><span class="pre">vector2</span></code> を定義して用いている．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! 2次元のベクトル</span>
<span class="linenos"> 2</span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vector2</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>
<span class="linenos"> 4</span><span class="k">end type </span><span class="n">vector2</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c">! 構造型の変数を宣言</span>
<span class="linenos"> 7</span><span class="k">type</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="c">! &#39;%&#39;を用いて各要素にアクセスが出来る</span>
<span class="linenos">10</span><span class="n">a</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_8</span>
<span class="linenos">11</span><span class="n">a</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_8</span>
</pre></div>
</div>
<p>構造型の各要素にアクセスするには上の例のように&quot;<code class="docutils literal notranslate"><span class="pre">%</span></code> &quot;を用いれば良い．構造型を用いると，常にセットで必要になるような複数のデータをまとめて保持することが出来るので，上手く利用すればプログラムが非常に見やすくなる．例えば非常に多くの引数を必要とするサブルーチンでも，構造型を利用してデータをまとめることで引数の数を減らして，スッキリとした形に書き換えることが出来るだろう <a class="footnote-reference brackets" href="#id29" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>．</p>
</section>
<section id="id17">
<h3><span class="section-number">9.6.2. </span>ユーザー定義演算子<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<p>構造型の機能として特筆すべきは，構造型に対する演算子を自分で定義することが出来るという点である．これをユーザー定義演算子と呼ぶ．演算子の定義は以下のように総称名の場合とほぼ同様である．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">interface </span><span class="n">operator</span><span class="w"> </span><span class="p">(.</span><span class="n">operator</span><span class="p">.)</span>
<span class="linenos">2</span><span class="w">   </span><span class="k">module procedure </span><span class="n">specific_procedure1</span><span class="p">,</span><span class="w"> </span><span class="n">specific_procedure2</span>
<span class="linenos">3</span><span class="k">end interface </span><span class="n">operator</span><span class="w"> </span><span class="p">(.</span><span class="n">operator</span><span class="p">.)</span>
</pre></div>
</div>
<p>演算子記号は <code class="docutils literal notranslate"><span class="pre">+</span></code>，<code class="docutils literal notranslate"><span class="pre">-</span></code>，<code class="docutils literal notranslate"><span class="pre">*</span></code>，<code class="docutils literal notranslate"><span class="pre">/</span></code> という組込み型に対して定義されている演算子か，または <code class="docutils literal notranslate"><span class="pre">.operator.</span></code> のように両側をピリオドで挟んだ名前のいずれかである．例として，ベクトル同士の和を各要素同士の和として <code class="docutils literal notranslate"><span class="pre">+</span></code> 演算子を定義しよう．以下の関数は2つのベクトルを引数に受け取り，要素同士の和を計算したものを結果として返す．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c">! + 演算子の中身</span>
<span class="linenos">2</span><span class="k">function </span><span class="n">add2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos">3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">4</span><span class="k">  type</span><span class="p">(</span><span class="n">vector2</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>
<span class="linenos">5</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ret</span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="w">  </span><span class="n">ret</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">%</span><span class="n">x</span>
<span class="linenos">8</span><span class="w">  </span><span class="n">ret</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">%</span><span class="n">y</span>
<span class="linenos">9</span><span class="k">end function </span><span class="n">add2</span>
</pre></div>
</div>
<p>これを <code class="docutils literal notranslate"><span class="pre">interface</span></code> を用いて</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">interface </span><span class="n">operator</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span>
<span class="linenos">2</span><span class="w">   </span><span class="k">module procedure </span><span class="n">add2</span>
<span class="linenos">3</span><span class="k">end interface </span><span class="n">operator</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span>
</pre></div>
</div>
<p>のように宣言しておくことで <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> の変数 <code class="docutils literal notranslate"><span class="pre">a</span></code>，<code class="docutils literal notranslate"><span class="pre">b</span></code> の和を <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code> のように記述することが出来る．この <code class="docutils literal notranslate"><span class="pre">+</span></code> 演算子の計算の実態は上の <code class="docutils literal notranslate"><span class="pre">add2</span></code> という関数である．</p>
<p>また演算子についても総称名を用いることが出来る．すなわち <code class="docutils literal notranslate"><span class="pre">add2</span></code> は引数が2つとも <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> であったが，例えばどちらか片方が実数型の場合の処理も定義して <code class="docutils literal notranslate"><span class="pre">interface</span></code> 宣言に加えておくことで，<code class="docutils literal notranslate"><span class="pre">+</span></code> 演算子を総称名として用いることが出来る．これを演算子のオーバーロードと呼ぶ．</p>
<p>例えば，先ほどの <code class="docutils literal notranslate"><span class="pre">add2</span></code> に加えて <code class="docutils literal notranslate"><span class="pre">add2_scalar1</span></code>，<code class="docutils literal notranslate"><span class="pre">add2_scalar2</span></code> の2つの関数を <code class="docutils literal notranslate"><span class="pre">interface</span></code> に加えておく．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">interface </span><span class="n">operator</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span>
<span class="linenos">2</span><span class="w">   </span><span class="k">module procedure </span><span class="n">add2</span><span class="p">,</span><span class="w"> </span><span class="n">add2_scalar1</span><span class="p">,</span><span class="w"> </span><span class="n">add2_scalar2</span>
<span class="linenos">3</span><span class="k">end interface </span><span class="n">operator</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span>
</pre></div>
</div>
<p>ここで <code class="docutils literal notranslate"><span class="pre">add2_scalar1</span></code>，<code class="docutils literal notranslate"><span class="pre">add2_scalar2</span></code> はそれぞれ以下のように定義されたものとする．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! + 演算子の中身: vector2 + scalar</span>
<span class="linenos"> 2</span><span class="k">function </span><span class="n">add2_scalar1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">  type</span><span class="p">(</span><span class="n">vector2</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ret</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">ret</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">ret</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<span class="linenos">10</span><span class="k">end function </span><span class="n">add2_scalar1</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="c">! + 演算子の中身: scalar + vector2</span>
<span class="linenos">13</span><span class="k">function </span><span class="n">add2_scalar2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="linenos">14</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">15</span><span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span>
<span class="linenos">16</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">vector2</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span>
<span class="linenos">17</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ret</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">  </span><span class="n">ret</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">%</span><span class="n">x</span>
<span class="linenos">20</span><span class="w">  </span><span class="n">ret</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">%</span><span class="n">y</span>
<span class="linenos">21</span><span class="k">end function </span><span class="n">add2_scalar2</span>
</pre></div>
</div>
<p>このようにしておけば，<code class="docutils literal notranslate"><span class="pre">vector2</span></code> 型と倍精度実数型の <code class="docutils literal notranslate"><span class="pre">+</span></code> 演算が可能になる．この時，<code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">1.0_8</span></code> のような演算では <code class="docutils literal notranslate"><span class="pre">add2_scalar1</span></code> が，<code class="docutils literal notranslate"><span class="pre">0.5_8</span> <span class="pre">+</span> <span class="pre">a</span></code> のような演算では <code class="docutils literal notranslate"><span class="pre">add2_scalar2</span></code> が自動的に呼び出されることになる．</p>
</section>
<section id="id18">
<h3><span class="section-number">9.6.3. </span>ユーザー定義代入文<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<p>代入文( <code class="docutils literal notranslate"><span class="pre">=</span></code>)に関しては，ユーザー定義演算子とは少し事情が異なるのでここで触れておく．まず代入文は，同じ構造型同士であればデフォルトで使用可能である(例えば <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> 型の変数同士で <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">b</span></code> としても良い)．この場合は，構造型の各要素で単純に代入文が実行される．異なる型同士での代入には，ユーザー定義代入文の定義が必要である．(明示的に指定しない限り，コンパイラには何が正しい代入動作か判断出来ないため．)</p>
<p>ユーザー定義演算子と異なり，代入文の実態はサブルーチンを用いて定義する．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c">! = 中身</span>
<span class="linenos"> 2</span><span class="k">subroutine </span><span class="n">assign2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">  type</span><span class="p">(</span><span class="n">vector2</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="c">! intent(out) に注意</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="c">! intent(in)  に注意</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="c">! どちらも同じ値</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="n">a</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">a</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span>
<span class="linenos">10</span><span class="k">end subroutine </span><span class="n">assign2</span>
</pre></div>
</div>
<p>このサブルーチンを代入文として用いるには以下の様な <code class="docutils literal notranslate"><span class="pre">interface</span></code> 宣言を行う．</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">interface </span><span class="n">assignment</span><span class="w"> </span><span class="p">(</span><span class="o">=</span><span class="p">)</span>
<span class="linenos">2</span><span class="w">   </span><span class="k">module procedure </span><span class="n">assign2</span>
<span class="linenos">3</span><span class="k">end interface </span><span class="n">assignment</span><span class="w"> </span><span class="p">(</span><span class="o">=</span><span class="p">)</span>
</pre></div>
</div>
<p>これによって <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">0.0_8</span></code> のように，<code class="docutils literal notranslate"><span class="pre">=</span></code> の右辺と左辺が異なる型の変数の場合であっても代入を行うことが出来るようになる．これにも総称名を用いてオーバーロードすることが可能である．</p>
</section>
</section>
<section id="id19">
<h2><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">9.7. </span>第9章 演習課題</a><a class="headerlink" href="#id19" title="Link to this heading"></a></h2>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<ul class="simple">
<li><p><a class="reference internal" href="chap09_kadai2_f90.html"><span class="doc">課題2 解答例</span></a></p></li>
<li><p><a class="reference internal" href="chap09_kadai3_f90.html"><span class="doc">課題3 解答例</span></a></p></li>
<li><p><a class="reference internal" href="chap09_kadai4_f90.html"><span class="doc">課題4 解答例</span></a></p></li>
<li><p><a class="reference internal" href="chap09_kadai5_f90.html"><span class="doc">課題5 解答例</span></a></p></li>
</ul>
</div>
<section id="id20">
<h3><span class="section-number">9.7.1. </span>課題1<a class="headerlink" href="#id20" title="Link to this heading"></a></h3>
<p>サンプルプログラムをコンパイル・実行して動作を確認せよ．さらに，適宜修正してその実行結果を確認せよ．</p>
</section>
<section id="id21">
<h3><span class="section-number">9.7.2. </span>課題2<a class="headerlink" href="#id21" title="Link to this heading"></a></h3>
<p>サンプルプログラム <span class="xref std std-doc">sample1.f90</span> を参考にして，数学定数を定義するモジュールを作成せよ．メインプログラムも作成して，動作を確認すること．特に <code class="docutils literal notranslate"><span class="pre">use</span></code> によるモジュール参照， <code class="docutils literal notranslate"><span class="pre">only</span></code> の使い方などを理解し，定数値の書き換えが出来ない(コンパイルエラーとなる)ことを確かめよ．数学定数としては例えば <span class="math notranslate nohighlight">\(\pi\)</span>, <span class="math notranslate nohighlight">\(\sqrt{\pi}\)</span>, <span class="math notranslate nohighlight">\(e\)</span> などを定義すれば良い．</p>
</section>
<section id="id22">
<h3><span class="section-number">9.7.3. </span>課題3<a class="headerlink" href="#id22" title="Link to this heading"></a></h3>
<p><span class="xref std std-doc">sample5.f90</span> のモジュール <code class="docutils literal notranslate"><span class="pre">mod_vector</span></code> で定義されている2次元のベクトル構造型 <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> を拡張し，以下の演算子を定義せよ．(以下で <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code> は共に <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> で宣言されたものとする．)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-</span></code> 演算子:
倍精度実数と <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> の間で以下のような演算が出来るようにする．</p></li>
</ul>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0_8</span><span class="w"> </span><span class="c">! b%x = a%x - 1.0_8; b%y = a%y - 1.0_8; と同値になるように</span>
<span class="linenos">2</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_8</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="c">! b%x = 1.0_8 - a%x; b%y = 1.0_8 - a%y; と同値になるように</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code> 演算子:
ベクトル積を返す演算子とする．(従って以下の2行が同じ結果となる．)</p></li>
</ul>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span>
<span class="linenos">2</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">%</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">%</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">%</span><span class="n">x</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">=</span></code> 演算子: 以下のような代入文を実行できるようにする．</p></li>
</ul>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_8</span><span class="w">            </span><span class="c">! x, yに同じ値(1.0)を代入</span>
<span class="linenos">2</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mf">2.0_8</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0_8</span><span class="o">/</span><span class="p">)</span><span class="w"> </span><span class="c">! xには2.0, yには1.0を代入</span>
</pre></div>
</div>
<p>ここで <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">=</span> <span class="pre">(/2.0_8,</span> <span class="pre">1.0_8/)</span></code> の右辺は長さ2の倍精度実数型の配列である．</p>
</section>
<section id="id23">
<h3><span class="section-number">9.7.4. </span>課題4<a class="headerlink" href="#id23" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">mod_vector</span></code> をさらに拡張し， <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code> を要素に持つ3次元ベクトルを表す構造型 <code class="docutils literal notranslate"><span class="pre">type(vector3)</span></code> を新たに定義せよ．また，この型に対する <code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">=</span></code> などの演算子を定義せよ．(ただし, <code class="docutils literal notranslate"><span class="pre">*</span></code> 演算子は通常のベクトル積を返すものとし，それ以外は <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code> の自然な拡張となるようにすること．)</p>
<p>さらにサブルーチン <code class="docutils literal notranslate"><span class="pre">show</span></code> をオーバーロードし， <code class="docutils literal notranslate"><span class="pre">type(vector2)</span></code>, <code class="docutils literal notranslate"><span class="pre">type(vector3)</span></code> のどちらの変数も引数に取れるようにせよ．</p>
<p>これによって，例えば</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">type</span><span class="p">(</span><span class="n">vector2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>
<span class="linenos"> 2</span><span class="k">type</span><span class="p">(</span><span class="n">vector3</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;--- vector2 ---&#39;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mf">1.0_8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0_8</span><span class="o">/</span><span class="p">)</span>
<span class="linenos"> 7</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_8</span>
<span class="linenos"> 8</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="linenos">11</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(&quot;a * b = &quot;, f12.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">b</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;--- vector3 ---&#39;</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mf">1.0_8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0_8</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0_8</span><span class="o">/</span><span class="p">)</span>
<span class="linenos">18</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_8</span>
<span class="linenos">19</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="linenos">22</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">23</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">24</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span>
<span class="linenos">25</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>のような記述が可能になるはずである．</p>
</section>
<section id="id24">
<h3><span class="section-number">9.7.5. </span>課題5<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<p>有理数を表す構造体を扱うモジュールを作成せよ．有理数同士の和差積商の演算子もそれぞれ定義すること．さらに，代入演算子で長さ2の整数配列を受け取れるようにし，また有理数を標準出力に表示するサブルーチン(例えば <code class="docutils literal notranslate"><span class="pre">show</span></code> )も作成せよ．(有理数の分子および分母は整数であるので2つの整数型を持つ構造体として定義すればよい．)</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">type</span><span class="p">(</span><span class="n">rational</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">/</span><span class="p">)</span>
<span class="linenos"> 4</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">/</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;a     = &#39;</span>
<span class="linenos"> 7</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;b     = &#39;</span>
<span class="linenos">10</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;a + b = &#39;</span>
<span class="linenos">13</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;a - b = &#39;</span>
<span class="linenos">16</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;a * b = &#39;</span>
<span class="linenos">19</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">advance</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;a / b = &#39;</span>
<span class="linenos">22</span><span class="k">call </span><span class="n">show</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>例えば上のようなプログラムをコンパイルして実行した結果が以下のようになればよい．約分も忘れずにすること．最大公約数を求める関数もしくはサブルーチンを用いると良い．(絶対値に注意すること．)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>$<span class="w"> </span>./a.out
<span class="linenos">2</span><span class="nv">a</span><span class="w">     </span><span class="o">=</span><span class="w">      </span><span class="m">1</span><span class="w"> </span>/<span class="w">      </span><span class="m">4</span>
<span class="linenos">3</span><span class="nv">b</span><span class="w">     </span><span class="o">=</span><span class="w">      </span><span class="m">2</span><span class="w"> </span>/<span class="w">      </span><span class="m">5</span>
<span class="linenos">4</span>a<span class="w"> </span>+<span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="m">13</span><span class="w"> </span>/<span class="w">     </span><span class="m">20</span>
<span class="linenos">5</span>a<span class="w"> </span>-<span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w">     </span>-3<span class="w"> </span>/<span class="w">     </span><span class="m">20</span>
<span class="linenos">6</span>a<span class="w"> </span>*<span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="m">1</span><span class="w"> </span>/<span class="w">     </span><span class="m">10</span>
<span class="linenos">7</span>a<span class="w"> </span>/<span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="m">5</span><span class="w"> </span>/<span class="w">      </span><span class="m">8</span>
</pre></div>
</div>
<hr class="docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id25" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">1</a><span class="fn-bracket">]</span></span>
<p>実は総称名はモジュールに限らず，メインプログラムの内部手続きでも用いることが出来る．その場合あまりありがたみは感じないかもしれないが．</p>
</aside>
<aside class="footnote brackets" id="id26" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id11">2</a><span class="fn-bracket">]</span></span>
<p>モジュール利用者がモジュール内部の処理に悪影響を与えないように振る舞ってくれればこれでも良いのだが，過度の期待は禁物である．</p>
</aside>
<aside class="footnote brackets" id="id27" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id12">3</a><span class="fn-bracket">]</span></span>
<p>このように内部データを敢えて隠ぺいする(外から見えないようにする)ことをカプセル化(encapsulation)と呼ぶ. これは現代的なオブジェクト指向プログラミングの基本的な概念である．</p>
</aside>
<aside class="footnote brackets" id="id28" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">4</a><span class="fn-bracket">]</span></span>
<p>Fortran 2003以降では派生型と呼ばれるらしい．(オブジェクト指向プログラミングをサポートしたからであろう．)</p>
</aside>
<aside class="footnote brackets" id="id29" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">5</a><span class="fn-bracket">]</span></span>
<p>もっともこれは好みの問題であって，引数が山ほどあるサブルーチンの方が分かりやすいという人もいるかもしれない．</p>
</aside>
</aside>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="chap08.html" class="btn btn-neutral float-left" title="8. 数値解析の基礎" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="chap10.html" class="btn btn-neutral float-right" title="10. 付録" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Takanobu Amano.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>